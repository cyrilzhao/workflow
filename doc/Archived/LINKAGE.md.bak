# åŠ¨æ€è¡¨å• UI è”åŠ¨è®¾è®¡æ–¹æ¡ˆ

## 1. è®¾è®¡åŸåˆ™

### 1.1 èŒè´£åˆ†ç¦»

- **JSON Schema**ï¼šè´Ÿè´£æ•°æ®éªŒè¯ï¼ˆValidationï¼‰
  - ä½¿ç”¨æ ‡å‡†çš„ `required`ã€`minLength`ã€`pattern` ç­‰è¿›è¡Œæ•°æ®æ ¡éªŒ
  - ä½¿ç”¨ `dependencies`ã€`if/then/else`ã€`allOf/anyOf/oneOf` è¿›è¡Œæ¡ä»¶éªŒè¯

- **UI æ‰©å±•ï¼ˆui å­—æ®µï¼‰**ï¼šè´Ÿè´£ UI è”åŠ¨é€»è¾‘ï¼ˆUI Logicï¼‰
  - å­—æ®µçš„æ˜¾ç¤º/éšè—
  - å­—æ®µçš„ç¦ç”¨/å¯ç”¨
  - å­—æ®µçš„åªè¯»çŠ¶æ€
  - å­—æ®µå€¼çš„è‡ªåŠ¨è®¡ç®—
  - å­—æ®µé€‰é¡¹çš„åŠ¨æ€å˜åŒ–

### 1.2 ä¸ react-hook-form çš„é›†æˆ

åˆ©ç”¨ react-hook-form çš„æ ¸å¿ƒ APIï¼š

- `watch(fieldName)` - ç›‘å¬å­—æ®µå˜åŒ–
- `setValue(fieldName, value)` - è®¾ç½®å­—æ®µå€¼
- `trigger(fieldName)` - è§¦å‘å­—æ®µéªŒè¯
- `getValues()` - è·å–æ‰€æœ‰è¡¨å•å€¼

## 2. UI è”åŠ¨é…ç½®è§„èŒƒ

### 2.1 åŸºç¡€ç»“æ„

```typescript
interface UILinkageConfig {
  // è”åŠ¨ç±»å‹
  type: 'visibility' | 'disabled' | 'readonly' | 'value' | 'options' | 'schema';

  // ä¾èµ–çš„å­—æ®µ
  dependencies: string[];

  // æ¡ä»¶è¡¨è¾¾å¼æˆ–å‡½æ•°åï¼ˆæè¿°"ä»€ä¹ˆæ—¶å€™è§¦å‘è”åŠ¨"ï¼‰
  when?: ConditionExpression | string;

  // æ¡ä»¶æ»¡è¶³æ—¶çš„æ•ˆæœï¼ˆæè¿°"è§¦å‘ååšä»€ä¹ˆ"ï¼‰
  fulfill?: LinkageEffect;

  // æ¡ä»¶ä¸æ»¡è¶³æ—¶çš„æ•ˆæœ
  otherwise?: LinkageEffect;
}

interface LinkageEffect {
  // çŠ¶æ€å˜æ›´
  state?: {
    visible?: boolean;
    disabled?: boolean;
    readonly?: boolean;
    required?: boolean;
  };
  // ç›´æ¥æŒ‡å®šå€¼ï¼ˆç”¨äº value ç±»å‹ï¼‰
  value?: any;
  // ç›´æ¥æŒ‡å®šé€‰é¡¹ï¼ˆç”¨äº options ç±»å‹ï¼‰
  options?: Array<{ label: string; value: any }>;
  // é€šè¿‡å‡½æ•°è®¡ç®—ï¼ˆæ ¹æ® linkage.type å†³å®šè®¡ç®—ç»“æœçš„ç”¨é€”ï¼‰
  function?: string;
  // ç›´æ¥æŒ‡å®š schemaï¼ˆç”¨äº schema ç±»å‹ï¼Œä¸æ¨èï¼Œå»ºè®®ä½¿ç”¨ functionï¼‰
  schema?: any;
}
```

**è®¾è®¡è¯´æ˜**ï¼š

- **èŒè´£åˆ†ç¦»**ï¼š`when` æè¿°æ¡ä»¶ï¼ˆä»€ä¹ˆæ—¶å€™è§¦å‘ï¼‰ï¼Œ`fulfill/otherwise` æè¿°æ•ˆæœï¼ˆè§¦å‘ååšä»€ä¹ˆï¼‰
- **ç»Ÿä¸€æ¥å£**ï¼š`function` å­—æ®µæ ¹æ® `linkage.type` è‡ªåŠ¨é€‚é…ï¼š
  - `value` ç±»å‹ï¼šå‡½æ•°è¿”å›å€¼èµ‹ç»™ `result.value`
  - `options` ç±»å‹ï¼šå‡½æ•°è¿”å›å€¼èµ‹ç»™ `result.options`
  - `schema` ç±»å‹ï¼šå‡½æ•°è¿”å›å€¼èµ‹ç»™ `result.schema`ï¼ˆæ”¯æŒå¼‚æ­¥åŠ è½½ï¼‰
  - `visibility`/`disabled`/`readonly` ç±»å‹ï¼šå‡½æ•°è¿”å›å€¼è½¬ä¸º boolean
- **çµæ´»æ€§**ï¼šæ”¯æŒç›´æ¥æŒ‡å®šå€¼/é€‰é¡¹/schemaï¼ˆ`value`/`options`/`schema`ï¼‰ï¼Œä¹Ÿæ”¯æŒå‡½æ•°è®¡ç®—ï¼ˆ`function`ï¼‰
- **å¼‚æ­¥æ”¯æŒ**ï¼šæ‰€æœ‰è”åŠ¨å‡½æ•°éƒ½æ”¯æŒå¼‚æ­¥æ“ä½œï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†å¼‚æ­¥ç«æ€æ¡ä»¶

### 2.2 æ¡ä»¶è¡¨è¾¾å¼è¯­æ³•

æ”¯æŒç®€å•çš„æ¡ä»¶è¡¨è¾¾å¼ï¼Œé¿å…ä½¿ç”¨ evalï¼š

```typescript
// å•æ¡ä»¶è¡¨è¾¾å¼
interface SingleCondition {
  field: string;
  operator: ConditionOperator;
  value?: any;
}

// é€»è¾‘ç»„åˆè¡¨è¾¾å¼
interface LogicalCondition {
  and?: ConditionExpression[];
  or?: ConditionExpression[];
}

// æ¡ä»¶è¡¨è¾¾å¼ï¼ˆè”åˆç±»å‹ï¼‰
export type ConditionExpression = SingleCondition | LogicalCondition;

// æ¡ä»¶æ“ä½œç¬¦
type ConditionOperator =
  | '=='
  | '!='
  | '>'
  | '<'
  | '>='
  | '<='
  | 'in'
  | 'notIn'
  | 'includes'
  | 'notIncludes'
  | 'isEmpty'
  | 'isNotEmpty';
```

**è¯´æ˜**ï¼šä½¿ç”¨è”åˆç±»å‹ç¡®ä¿ç±»å‹å®‰å…¨ï¼Œå•æ¡ä»¶å’Œé€»è¾‘ç»„åˆä¸èƒ½æ··ç”¨ã€‚

### 2.3 è·¯å¾„å¼•ç”¨æ ¼å¼

è”åŠ¨é…ç½®ä¸­çš„å­—æ®µå¼•ç”¨æ”¯æŒä»¥ä¸‹æ ¼å¼ï¼š

| æ ¼å¼             | è¯­æ³•               | ä½¿ç”¨åœºæ™¯               | ç¤ºä¾‹                               |
| ---------------- | ------------------ | ---------------------- | ---------------------------------- |
| **JSON Pointer** | `#/properties/...` | è·¨å±‚çº§å­—æ®µå¼•ç”¨ï¼ˆæ¨èï¼‰ | `#/properties/user/properties/age` |
| **ç›¸å¯¹è·¯å¾„**     | `./fieldName`      | æ•°ç»„å…ƒç´ å†…éƒ¨å­—æ®µå¼•ç”¨   | `./type`                           |
| **ç®€å•å­—æ®µå**   | `fieldName`        | åŒçº§å­—æ®µå¼•ç”¨ï¼ˆä¸æ¨èï¼‰ | `age`                              |

**æ¨èä½¿ç”¨ JSON Pointer æ ¼å¼**ï¼Œå®ƒæä¾›äº†æ˜ç¡®çš„è·¯å¾„è¯­ä¹‰ï¼Œé¿å…æ­§ä¹‰ã€‚

è¯¦ç»†çš„è·¯å¾„ç³»ç»Ÿè¯´æ˜è¯·å‚è€ƒï¼š[å­—æ®µè·¯å¾„å®Œå…¨æŒ‡å—](./FIELD_PATH_GUIDE.md)

## 3. ä½¿ç”¨ç¤ºä¾‹

### 3.1 å­—æ®µæ˜¾ç¤º/éšè—

```json
{
  "type": "object",
  "properties": {
    "hasAddress": {
      "type": "boolean",
      "title": "æ˜¯å¦å¡«å†™åœ°å€"
    },
    "address": {
      "type": "string",
      "title": "è¯¦ç»†åœ°å€",
      "ui": {
        "linkage": {
          "type": "visibility",
          "dependencies": ["#/properties/hasAddress"],
          "when": {
            "field": "#/properties/hasAddress",
            "operator": "==",
            "value": true
          },
          "fulfill": {
            "state": { "visible": true }
          },
          "otherwise": {
            "state": { "visible": false }
          }
        }
      }
    }
  }
}
```

### 3.2 å­—æ®µç¦ç”¨/å¯ç”¨

```json
{
  "type": "object",
  "properties": {
    "accountType": {
      "type": "string",
      "title": "è´¦æˆ·ç±»å‹",
      "enum": ["free", "premium"]
    },
    "advancedFeatures": {
      "type": "boolean",
      "title": "é«˜çº§åŠŸèƒ½",
      "ui": {
        "linkage": {
          "type": "disabled",
          "dependencies": ["#/properties/accountType"],
          "when": {
            "field": "#/properties/accountType",
            "operator": "==",
            "value": "free"
          },
          "fulfill": {
            "state": { "disabled": true }
          },
          "otherwise": {
            "state": { "disabled": false }
          }
        }
      }
    }
  }
}
```

### 3.3 å­—æ®µå€¼è‡ªåŠ¨è®¡ç®—

```json
{
  "type": "object",
  "properties": {
    "price": {
      "type": "number",
      "title": "å•ä»·"
    },
    "quantity": {
      "type": "number",
      "title": "æ•°é‡"
    },
    "total": {
      "type": "number",
      "title": "æ€»ä»·",
      "ui": {
        "readonly": true,
        "linkage": {
          "type": "value",
          "dependencies": ["#/properties/price", "#/properties/quantity"],
          "fulfill": {
            "function": "calculateTotal"
          }
        }
      }
    }
  }
}
```

å¯¹åº”çš„è®¡ç®—å‡½æ•°ï¼š

```typescript
const linkageFunctions = {
  calculateTotal: (formData: any, context?: LinkageFunctionContext) => {
    return (formData.price || 0) * (formData.quantity || 0);
  },
};
```

### 3.4 åŠ¨æ€é€‰é¡¹

```json
{
  "type": "object",
  "properties": {
    "country": {
      "type": "string",
      "title": "å›½å®¶",
      "enum": ["china", "usa"]
    },
    "province": {
      "type": "string",
      "title": "çœä»½/å·",
      "ui": {
        "linkage": {
          "type": "options",
          "dependencies": ["#/properties/country"],
          "fulfill": {
            "function": "getProvinceOptions"
          }
        }
      }
    }
  }
}
```

å¯¹åº”çš„é€‰é¡¹å‡½æ•°ï¼š

```typescript
const linkageFunctions = {
  getProvinceOptions: (formData: any, context?: LinkageFunctionContext) => {
    if (formData.country === 'china') {
      return [
        { label: 'åŒ—äº¬', value: 'beijing' },
        { label: 'ä¸Šæµ·', value: 'shanghai' },
      ];
    } else if (formData.country === 'usa') {
      return [
        { label: 'California', value: 'ca' },
        { label: 'New York', value: 'ny' },
      ];
    }
    return [];
  },
};
```

### 3.5 åŠ¨æ€ Schemaï¼ˆå¼‚æ­¥åŠ è½½ï¼‰

```json
{
  "type": "object",
  "properties": {
    "productType": {
      "type": "string",
      "title": "Product Type",
      "enum": ["laptop", "smartphone", "tablet"],
      "enumNames": ["Laptop", "Smartphone", "Tablet"]
    },
    "configuration": {
      "type": "object",
      "title": "Product Configuration",
      "properties": {},
      "ui": {
        "widget": "nested-form",
        "linkage": {
          "type": "schema",
          "dependencies": ["#/properties/productType"],
          "when": {
            "field": "#/properties/productType",
            "operator": "isNotEmpty"
          },
          "fulfill": {
            "function": "loadProductSchema"
          }
        }
      }
    }
  },
  "required": ["productType"]
}
```

å¯¹åº”çš„ schema åŠ è½½å‡½æ•°ï¼š

```typescript
const linkageFunctions = {
  /**
   * å¼‚æ­¥åŠ è½½äº§å“é…ç½® schema
   */
  loadProductSchema: async (formData: any, context?: LinkageFunctionContext) => {
    const productType = formData?.productType;

    if (!productType) {
      return { type: 'object', properties: {} };
    }

    // æ¨¡æ‹Ÿ API è°ƒç”¨
    const response = await fetch(`/api/products/${productType}/schema`);
    const schema = await response.json();

    return schema;
  },
};
```

**é‡è¦è¯´æ˜**ï¼š

1. **Schema æ›´æ–°èŒƒå›´**ï¼šè¿”å›çš„ schema åªä¼šæ›´æ–°ä»¥ä¸‹å­—æ®µï¼Œä¸ä¼šè¦†ç›–åŸæœ‰çš„ `ui.linkage` é…ç½®ï¼š
   - `properties`ï¼šå­—æ®µå®šä¹‰
   - `required`ï¼šå¿…å¡«å­—æ®µ
   - æ ¡éªŒç›¸å…³å­—æ®µï¼š`minProperties`ã€`maxProperties`ã€`dependencies`ã€`if/then/else`ã€`allOf/anyOf/oneOf/not`

2. **å¼‚æ­¥ç«æ€æ¡ä»¶å¤„ç†**ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†å¼‚æ­¥è¯·æ±‚çš„ç«æ€æ¡ä»¶ã€‚å½“ç”¨æˆ·å¿«é€Ÿåˆ‡æ¢ `productType` æ—¶ï¼Œåªæœ‰æœ€åä¸€æ¬¡è¯·æ±‚çš„ç»“æœä¼šè¢«åº”ç”¨ï¼Œä¹‹å‰çš„è¿‡æœŸç»“æœä¼šè¢«è‡ªåŠ¨ä¸¢å¼ƒã€‚

3. **ä½¿ç”¨åœºæ™¯**ï¼š
   - æ ¹æ®ç”¨æˆ·é€‰æ‹©åŠ¨æ€åŠ è½½è¡¨å•ç»“æ„
   - ä»æœåŠ¡å™¨è·å–é…ç½®åŒ–çš„è¡¨å•å®šä¹‰
   - å®ç°å¤šæ­¥éª¤è¡¨å•çš„åŠ¨æ€æµç¨‹

## 4. å¤æ‚è”åŠ¨åœºæ™¯

### 4.1 å¤šå­—æ®µè”åŠ¨

```json
{
  "type": "object",
  "properties": {
    "age": {
      "type": "integer",
      "title": "å¹´é¾„"
    },
    "income": {
      "type": "number",
      "title": "å¹´æ”¶å…¥"
    },
    "loanAmount": {
      "type": "number",
      "title": "å¯è´·æ¬¾é¢åº¦",
      "ui": {
        "linkage": {
          "type": "visibility",
          "dependencies": ["#/properties/age", "#/properties/income"],
          "when": {
            "and": [
              {
                "field": "#/properties/age",
                "operator": ">=",
                "value": 18
              },
              {
                "field": "#/properties/income",
                "operator": ">=",
                "value": 50000
              }
            ]
          },
          "fulfill": {
            "state": { "visible": true }
          },
          "otherwise": {
            "state": { "visible": false }
          }
        }
      }
    }
  }
}
```

### 4.2 åµŒå¥—æ¡ä»¶

```json
{
  "type": "object",
  "properties": {
    "userType": {
      "type": "string",
      "title": "ç”¨æˆ·ç±»å‹",
      "enum": ["individual", "company"]
    },
    "country": {
      "type": "string",
      "title": "å›½å®¶",
      "enum": ["china", "japan", "usa"]
    },
    "age": {
      "type": "integer",
      "title": "å¹´é¾„"
    },
    "idCard": {
      "type": "string",
      "title": "èº«ä»½è¯å·",
      "ui": {
        "linkage": {
          "type": "visibility",
          "dependencies": ["#/properties/userType", "#/properties/country", "#/properties/age"],
          "when": {
            "and": [
              {
                "field": "#/properties/userType",
                "operator": "==",
                "value": "individual"
              },
              {
                "or": [
                  {
                    "and": [
                      {
                        "field": "#/properties/country",
                        "operator": "==",
                        "value": "china"
                      },
                      {
                        "field": "#/properties/age",
                        "operator": ">=",
                        "value": 16
                      }
                    ]
                  },
                  {
                    "and": [
                      {
                        "field": "#/properties/country",
                        "operator": "==",
                        "value": "japan"
                      },
                      {
                        "field": "#/properties/age",
                        "operator": ">=",
                        "value": 20
                      }
                    ]
                  }
                ]
              }
            ]
          }
        }
      }
    }
  }
}
```

**è¯´æ˜**ï¼šç”¨æˆ·ç±»å‹å¿…é¡»æ˜¯"ä¸ªäºº" **ä¸”**ï¼ˆå›½å®¶æ˜¯ä¸­å›½ **ä¸”** å¹´é¾„ â‰¥ 16ï¼‰**æˆ–**ï¼ˆå›½å®¶æ˜¯æ—¥æœ¬ **ä¸”** å¹´é¾„ â‰¥ 20ï¼‰

## 5. ä¸ JSON Schema éªŒè¯çš„é…åˆ

UI è”åŠ¨å’Œæ•°æ®éªŒè¯æ˜¯ç‹¬ç«‹çš„ï¼š

```json
{
  "type": "object",
  "properties": {
    "hasAddress": {
      "type": "boolean",
      "title": "æ˜¯å¦å¡«å†™åœ°å€"
    },
    "address": {
      "type": "string",
      "title": "è¯¦ç»†åœ°å€",
      "minLength": 5,
      "ui": {
        "linkage": {
          "type": "visibility",
          "dependencies": ["#/properties/hasAddress"],
          "when": {
            "field": "#/properties/hasAddress",
            "operator": "==",
            "value": true
          }
        }
      }
    }
  },
  "if": {
    "properties": { "hasAddress": { "const": true } }
  },
  "then": {
    "required": ["address"]
  }
}
```

**è¯´æ˜**ï¼š

- `ui.linkage` æ§åˆ¶ `address` å­—æ®µçš„æ˜¾ç¤º/éšè—ï¼ˆUI å±‚é¢ï¼‰
- `if/then` æ§åˆ¶å½“ `hasAddress` ä¸º true æ—¶ï¼Œ`address` å¿…å¡«ï¼ˆéªŒè¯å±‚é¢ï¼‰
- ä¸¤è€…é…åˆä½¿ç”¨ï¼ŒèŒè´£æ¸…æ™°

---

## 6. å®ç°æ–¹æ¡ˆ

### 6.1 ç±»å‹å®šä¹‰

**å®é™…å®ç°**ï¼š`src/types/linkage.ts`

```typescript
/**
 * è”åŠ¨ç±»å‹
 */
export type LinkageType = 'visibility' | 'disabled' | 'readonly' | 'value' | 'options' | 'schema';

/**
 * æ¡ä»¶æ“ä½œç¬¦
 */
export type ConditionOperator =
  | '=='
  | '!='
  | '>'
  | '<'
  | '>='
  | '<='
  | 'in'
  | 'notIn'
  | 'includes'
  | 'notIncludes'
  | 'isEmpty'
  | 'isNotEmpty';

/**
 * å•æ¡ä»¶è¡¨è¾¾å¼
 */
interface SingleCondition {
  field: string;
  operator: ConditionOperator;
  value?: any;
}

/**
 * é€»è¾‘ç»„åˆè¡¨è¾¾å¼
 */
interface LogicalCondition {
  and?: ConditionExpression[];
  or?: ConditionExpression[];
}

/**
 * æ¡ä»¶è¡¨è¾¾å¼ï¼ˆè”åˆç±»å‹ï¼‰
 */
export type ConditionExpression = SingleCondition | LogicalCondition;

/**
 * è”åŠ¨æ•ˆæœå®šä¹‰
 */
export interface LinkageEffect {
  state?: {
    visible?: boolean;
    disabled?: boolean;
    readonly?: boolean;
    required?: boolean;
  };
  value?: any;
  options?: Array<{ label: string; value: any }>;
  function?: string;
}

/**
 * è”åŠ¨é…ç½®
 */
export interface LinkageConfig {
  type: LinkageType;
  dependencies: string[];
  when?: ConditionExpression | string;
  fulfill?: LinkageEffect;
  otherwise?: LinkageEffect;
}

/**
 * è”åŠ¨ç»“æœ
 */
export interface LinkageResult {
  visible?: boolean;
  disabled?: boolean;
  readonly?: boolean;
  value?: any;
  options?: Array<{ label: string; value: any }>;
  schema?: any; // ExtendedJSONSchemaï¼Œç”¨äº schema ç±»å‹è”åŠ¨
}

/**
 * è”åŠ¨å‡½æ•°ä¸Šä¸‹æ–‡ä¿¡æ¯
 */
export interface LinkageFunctionContext {
  /** å½“å‰å­—æ®µçš„å®Œæ•´è·¯å¾„ï¼ˆå¦‚ 'contacts.0.companyName'ï¼‰ */
  fieldPath: string;
  /** å½“å‰å­—æ®µåœ¨æ•°ç»„ä¸­çš„ç´¢å¼•ï¼ˆå¦‚æœæ˜¯æ•°ç»„å…ƒç´ å­—æ®µï¼‰ */
  arrayIndex?: number;
  /** å½“å‰å­—æ®µæ‰€åœ¨çš„æ•°ç»„è·¯å¾„ï¼ˆå¦‚æœæ˜¯æ•°ç»„å…ƒç´ å­—æ®µï¼Œå¦‚ 'contacts'ï¼‰ */
  arrayPath?: string;
}

/**
 * è”åŠ¨å‡½æ•°ç­¾åï¼ˆæ”¯æŒåŒæ­¥å’Œå¼‚æ­¥å‡½æ•°ï¼‰
 */
export type LinkageFunction = (
  formData: Record<string, any>,
  context?: LinkageFunctionContext
) => any | Promise<any>;
```

### 6.2 æ¡ä»¶è¡¨è¾¾å¼æ±‚å€¼å™¨

**å®é™…å®ç°**ï¼š`src/utils/conditionEvaluator.ts`

```typescript
import type { ConditionExpression, ConditionOperator } from '@/types/linkage';
import { PathResolver } from './pathResolver';

/**
 * æ¡ä»¶è¡¨è¾¾å¼æ±‚å€¼å™¨
 */
export class ConditionEvaluator {
  /**
   * æ±‚å€¼æ¡ä»¶è¡¨è¾¾å¼
   */
  static evaluate(condition: ConditionExpression, formData: Record<string, any>): boolean {
    // å¤„ç†é€»è¾‘ç»„åˆ - and
    if ('and' in condition && condition.and) {
      return condition.and.every(c => this.evaluate(c, formData));
    }

    // å¤„ç†é€»è¾‘ç»„åˆ - or
    if ('or' in condition && condition.or) {
      return condition.or.some(c => this.evaluate(c, formData));
    }

    // å•æ¡ä»¶æ±‚å€¼
    if ('field' in condition) {
      const fieldValue = PathResolver.resolve(condition.field, formData);
      return this.evaluateOperator(fieldValue, condition.operator, condition.value);
    }

    return false;
  }

  /**
   * æ±‚å€¼æ“ä½œç¬¦
   */
  private static evaluateOperator(
    fieldValue: any,
    operator: ConditionOperator,
    compareValue: any
  ): boolean {
    switch (operator) {
      case '==':
        return fieldValue === compareValue;
      case '!=':
        return fieldValue !== compareValue;
      case '>':
        return fieldValue > compareValue;
      case '<':
        return fieldValue < compareValue;
      case '>=':
        return fieldValue >= compareValue;
      case '<=':
        return fieldValue <= compareValue;
      case 'in':
        return Array.isArray(compareValue) && compareValue.includes(fieldValue);
      case 'notIn':
        return Array.isArray(compareValue) && !compareValue.includes(fieldValue);
      case 'includes':
        return Array.isArray(fieldValue) && fieldValue.includes(compareValue);
      case 'notIncludes':
        return Array.isArray(fieldValue) && !fieldValue.includes(compareValue);
      case 'isEmpty':
        return (
          fieldValue === null ||
          fieldValue === undefined ||
          fieldValue === '' ||
          (Array.isArray(fieldValue) && fieldValue.length === 0)
        );
      case 'isNotEmpty':
        return (
          fieldValue !== null &&
          fieldValue !== undefined &&
          fieldValue !== '' &&
          (!Array.isArray(fieldValue) || fieldValue.length > 0)
        );
      default:
        return false;
    }
  }
}
```

**å…³é”®ç‰¹æ€§**ï¼š

- âœ… ä½¿ç”¨ `PathResolver.resolve()` ç»Ÿä¸€å¤„ç†å­—æ®µè·¯å¾„
- âœ… æ”¯æŒç®€å•å­—æ®µåã€ç‚¹å·è·¯å¾„å’Œ JSON Pointer æ ¼å¼
- âœ… æ”¯æŒ `and`/`or` é€»è¾‘ç»„åˆçš„é€’å½’æ±‚å€¼
- âœ… å®Œæ•´çš„æ“ä½œç¬¦æ”¯æŒï¼ˆåŒ…æ‹¬ `isEmpty`/`isNotEmpty`ï¼‰

### 6.3 è”åŠ¨ç®¡ç†å™¨

**å®é™…å®ç°**ï¼š`src/hooks/useLinkageManager.ts`

æ ¸å¿ƒåŠŸèƒ½ï¼š

1. **æ„å»ºä¾èµ–å›¾**ï¼šä½¿ç”¨ `DependencyGraph` ç®¡ç†å­—æ®µä¾èµ–å…³ç³»
2. **åˆå§‹åŒ–è”åŠ¨çŠ¶æ€**ï¼šå¹¶è¡Œè®¡ç®—æ‰€æœ‰å­—æ®µçš„åˆå§‹çŠ¶æ€
3. **ç›‘å¬å­—æ®µå˜åŒ–**ï¼šä½¿ç”¨ `watch` ç›‘å¬ä¾èµ–å­—æ®µå˜åŒ–
4. **ç²¾ç¡®æ›´æ–°**ï¼šåªé‡æ–°è®¡ç®—å—å½±å“çš„å­—æ®µ
5. **è‡ªåŠ¨å€¼æ›´æ–°**ï¼š`value` ç±»å‹è”åŠ¨è‡ªåŠ¨è°ƒç”¨ `form.setValue`

```typescript
export function useLinkageManager({
  form,
  linkages,
  linkageFunctions = {},
  pathMappings = [],
}: LinkageManagerOptions) {
  const { watch, getValues } = form;

  // æ„å»ºä¾èµ–å›¾
  const dependencyGraph = useMemo(() => {
    const graph = new DependencyGraph();
    Object.entries(linkages).forEach(([fieldName, linkage]) => {
      linkage.dependencies.forEach(dep => {
        const normalizedDep = PathResolver.toFieldPath(dep);
        graph.addDependency(fieldName, normalizedDep);
      });
    });

    // æ£€æµ‹å¾ªç¯ä¾èµ–
    const cycle = graph.detectCycle();
    if (cycle) {
      console.error('æ£€æµ‹åˆ°å¾ªç¯ä¾èµ–:', cycle.join(' -> '));
    }

    return graph;
  }, [linkages]);

  // è”åŠ¨çŠ¶æ€ç¼“å­˜
  const [linkageStates, setLinkageStates] = useState<Record<string, LinkageResult>>({});

  // åˆå§‹åŒ–è”åŠ¨çŠ¶æ€
  useEffect(() => {
    (async () => {
      const formData = getValues();
      const states: Record<string, LinkageResult> = {};

      // å¹¶è¡Œè®¡ç®—æ‰€æœ‰å­—æ®µçš„åˆå§‹è”åŠ¨çŠ¶æ€
      const results = await Promise.allSettled(
        Object.entries(linkages).map(async ([fieldName, linkage]) => ({
          fieldName,
          result: await evaluateLinkage(linkage, formData, linkageFunctions, fieldName),
        }))
      );

      results.forEach(result => {
        if (result.status === 'fulfilled') {
          states[result.value.fieldName] = result.value.result;
        }
      });

      setLinkageStates(states);
    })();
  }, [linkages, linkageFunctions, getValues]);

  // ç»Ÿä¸€çš„å­—æ®µå˜åŒ–ç›‘å¬å’Œè”åŠ¨å¤„ç†
  useEffect(() => {
    const subscription = watch((_, { name }) => {
      if (!name) return;

      // è·å–å—å½±å“çš„å­—æ®µï¼ˆä½¿ç”¨ä¾èµ–å›¾ç²¾ç¡®è®¡ç®—ï¼‰
      const affectedFields = dependencyGraph.getAffectedFields(name);
      if (affectedFields.length === 0) return;

      const formData = getValues();

      // å¼‚æ­¥å¤„ç†è”åŠ¨é€»è¾‘
      (async () => {
        const newStates: Record<string, LinkageResult> = {};

        // å¹¶è¡Œè®¡ç®—æ‰€æœ‰å—å½±å“å­—æ®µçš„è”åŠ¨ç»“æœ
        const results = await Promise.allSettled(
          affectedFields.map(async fieldName => {
            const linkage = linkages[fieldName];
            if (!linkage) return null;

            const result = await evaluateLinkage(linkage, formData, linkageFunctions, fieldName);
            return { fieldName, linkage, result };
          })
        );

        // å¤„ç†ç»“æœ
        results.forEach(promiseResult => {
          if (promiseResult.status === 'fulfilled' && promiseResult.value) {
            const { fieldName, linkage, result } = promiseResult.value;
            newStates[fieldName] = result;

            // å¤„ç†å€¼è”åŠ¨ï¼šè‡ªåŠ¨æ›´æ–°è¡¨å•å­—æ®µå€¼
            if (linkage.type === 'value' && result.value !== undefined) {
              const currentValue = formData[fieldName];
              if (currentValue !== result.value) {
                form.setValue(fieldName, result.value, {
                  shouldValidate: true,
                  shouldDirty: true,
                });
              }
            }
          }
        });

        // æ‰¹é‡æ›´æ–°çŠ¶æ€
        if (Object.keys(newStates).length > 0) {
          setLinkageStates(prev => ({ ...prev, ...newStates }));
        }
      })();
    });

    return () => subscription.unsubscribe();
  }, [watch, form, getValues, linkages, linkageFunctions, dependencyGraph]);

  return linkageStates;
}
```

**å…³é”®ç‰¹æ€§**ï¼š

- âœ… å¼‚æ­¥æ”¯æŒï¼šå®Œæ•´æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥è”åŠ¨å‡½æ•°
- âœ… é”™è¯¯éš”ç¦»ï¼šä½¿ç”¨ `Promise.allSettled` ç¡®ä¿å•ä¸ªå­—æ®µå¤±è´¥ä¸ä¼šé˜»å¡å…¶ä»–å­—æ®µ
- âœ… å¹¶è¡Œæ‰§è¡Œï¼šå¤šä¸ªå­—æ®µçš„è”åŠ¨è®¡ç®—å¹¶è¡Œæ‰§è¡Œ
- âœ… ä¾èµ–å›¾ä¼˜åŒ–ï¼šç²¾ç¡®è®¡ç®—å—å½±å“çš„å­—æ®µï¼Œé¿å…ä¸å¿…è¦çš„é‡æ–°è®¡ç®—
- âœ… å¾ªç¯ä¾èµ–æ£€æµ‹ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶è­¦å‘Šå¾ªç¯ä¾èµ–

### 6.4 PathMapping æœºåˆ¶

å½“ä½¿ç”¨è·¯å¾„é€æ˜åŒ–ï¼ˆ`flattenPath`ï¼‰æ—¶ï¼Œé€»è¾‘è·¯å¾„å’Œç‰©ç†è·¯å¾„ä¼šä¸ä¸€è‡´ã€‚PathMapping æœºåˆ¶ç”¨äºå¤„ç†è¿™ç§æ˜ å°„å…³ç³»ã€‚

**ç±»å‹å®šä¹‰**ï¼š`src/utils/schemaLinkageParser.ts`

```typescript
export interface PathMapping {
  logicalPath: string;
  physicalPath: string;
  isArray?: boolean;
  skippedSegments?: string[];
}
```

**è·¯å¾„è½¬æ¢å‡½æ•°**ï¼š

```typescript
export function logicalToPhysicalPath(logicalPath: string, pathMappings: PathMapping[]): string {
  for (const mapping of pathMappings) {
    if (logicalPath === mapping.logicalPath) {
      return mapping.physicalPath;
    }
    if (logicalPath.startsWith(mapping.logicalPath + '.')) {
      const suffix = logicalPath.slice(mapping.logicalPath.length);
      return mapping.physicalPath + suffix;
    }
  }
  return logicalPath;
}
```

### 6.5 åˆ†å±‚è®¡ç®—ç­–ç•¥

å½“è¡¨å•åŒ…å«åµŒå¥—ç»“æ„æ—¶ï¼Œè”åŠ¨çŠ¶æ€çš„è®¡ç®—é‡‡ç”¨åˆ†å±‚ç­–ç•¥ã€‚

**æ ¸å¿ƒåŸåˆ™**ï¼š

1. æ¯å±‚ DynamicForm åªè®¡ç®—è‡ªå·±èŒƒå›´å†…çš„è”åŠ¨
2. é€šè¿‡ Context å…±äº«è¡¨å•å®ä¾‹å’Œçˆ¶çº§è”åŠ¨çŠ¶æ€
3. å­çº§è¿‡æ»¤æ‰å·²åœ¨çˆ¶çº§è®¡ç®—çš„è”åŠ¨ï¼Œé¿å…é‡å¤è®¡ç®—

**Context å®šä¹‰**ï¼š

```typescript
interface LinkageStateContextValue {
  parentLinkageStates: Record<string, LinkageResult>;
  form: UseFormReturn<any>;
  rootSchema: ExtendedJSONSchema;
  pathPrefix?: string;
  linkageFunctions?: Record<string, LinkageFunction>;
}
```

### 6.6 DynamicForm é›†æˆ

**å®é™…å®ç°**ï¼š`src/components/DynamicForm/DynamicForm.tsx`

#### æ­¥éª¤ 1ï¼šContext è·å–ï¼ˆé›†ä¸­ç®¡ç†ï¼‰

```typescript
const parentFormContext = useFormContext();
const linkageStateContext = useLinkageStateContext();
const nestedSchemaRegistry = useNestedSchemaRegistryOptional();
```

#### æ­¥éª¤ 2ï¼šè”åŠ¨é…ç½®è§£æ

```typescript
// è§£æ schema ä¸­çš„è”åŠ¨é…ç½®ï¼ˆåŒ…å«è·¯å¾„æ˜ å°„ï¼‰
const {
  linkages: rawLinkages,
  pathMappings,
  hasFlattenPath,
} = useMemo(() => {
  const parsed = parseSchemaLinkages(schema);
  if (process.env.NODE_ENV !== 'production') {
    console.log('[DynamicForm] è§£æ schema è”åŠ¨é…ç½®:', {
      schema: schema.title || 'root',
      pathPrefix,
      asNestedForm,
      rawLinkages: parsed.linkages,
      pathMappingsCount: parsed.pathMappings.length,
      hasFlattenPath: parsed.hasFlattenPath,
    });
  }
  return parsed;
}, [schema, pathPrefix, asNestedForm]);
```

**è¯´æ˜**ï¼š

- `parseSchemaLinkages` è§£æ Schemaï¼Œæå–è”åŠ¨é…ç½®
- åŒæ—¶ç”Ÿæˆ PathMapping è¡¨ï¼ˆç”¨äºè·¯å¾„é€æ˜åŒ–ï¼‰
- æ£€æµ‹æ˜¯å¦ä½¿ç”¨äº† `flattenPath`

#### æ­¥éª¤ 3ï¼šè·¯å¾„è½¬æ¢å’Œè¿‡æ»¤

```typescript
// ç»Ÿä¸€å¤„ç†è”åŠ¨é…ç½®ï¼šè·¯å¾„è½¬æ¢ -> è¿‡æ»¤çˆ¶çº§è”åŠ¨
const { processedLinkages, formToUse, effectiveLinkageFunctions } = useMemo(() => {
  // æ­¥éª¤3.1: è·¯å¾„è½¬æ¢
  let linkages = rawLinkages;
  if (asNestedForm && pathPrefix) {
    // å°†ç›¸å¯¹è·¯å¾„è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
    const transformed = transformToAbsolutePaths(rawLinkages, pathPrefix);

    // æ­¥éª¤3.2: è¿‡æ»¤çˆ¶çº§å·²è®¡ç®—çš„è”åŠ¨
    if (linkageStateContext?.parentLinkageStates) {
      const filtered: Record<string, LinkageConfig> = {};
      Object.entries(transformed).forEach(([key, value]) => {
        // å¦‚æœçˆ¶çº§æ²¡æœ‰è®¡ç®—è¿‡è¿™ä¸ªå­—æ®µï¼Œæ‰ä¿ç•™
        if (!(key in linkageStateContext.parentLinkageStates)) {
          filtered[key] = value;
        }
      });
      linkages = filtered;
    } else {
      linkages = transformed;
    }
  }

  // æ­¥éª¤3.3: ç¡®å®šä½¿ç”¨çš„è¡¨å•å®ä¾‹å’Œè”åŠ¨å‡½æ•°
  return {
    processedLinkages: linkages,
    formToUse: linkageStateContext?.form || methods,
    effectiveLinkageFunctions:
      linkageFunctions || linkageStateContext?.linkageFunctions || EMPTY_LINKAGE_FUNCTIONS,
  };
}, [
  rawLinkages,
  asNestedForm,
  pathPrefix,
  linkageStateContext?.parentLinkageStates,
  linkageStateContext?.form,
  linkageStateContext?.linkageFunctions,
  linkageFunctions,
  methods,
]);
```

**è¯´æ˜**ï¼š

- **è·¯å¾„è½¬æ¢**ï¼šåµŒå¥—è¡¨å•ä¸­ï¼Œå°†ç›¸å¯¹è·¯å¾„è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
- **è¿‡æ»¤çˆ¶çº§è”åŠ¨**ï¼šé¿å…é‡å¤è®¡ç®—å·²åœ¨çˆ¶çº§è®¡ç®—è¿‡çš„è”åŠ¨
- **å…±äº«è¡¨å•å®ä¾‹**ï¼šå­çº§ä½¿ç”¨çˆ¶çº§çš„è¡¨å•å®ä¾‹ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´

#### æ­¥éª¤ 4ï¼šè®¡ç®—å’Œåˆå¹¶è”åŠ¨çŠ¶æ€

```typescript
// æ­¥éª¤4.1: è®¡ç®—è‡ªå·±çš„è”åŠ¨çŠ¶æ€
const ownLinkageStates = useArrayLinkageManager({
  form: formToUse,
  baseLinkages: processedLinkages,
  linkageFunctions: effectiveLinkageFunctions,
  schema,
  pathMappings,
});

// æ­¥éª¤4.2: åˆå¹¶çˆ¶çº§å’Œè‡ªå·±çš„è”åŠ¨çŠ¶æ€
const linkageStates = useMemo(() => {
  if (linkageStateContext?.parentLinkageStates) {
    const merged = { ...linkageStateContext.parentLinkageStates, ...ownLinkageStates };
    if (process.env.NODE_ENV !== 'production') {
      console.log('[DynamicForm] åˆå¹¶è”åŠ¨çŠ¶æ€:', {
        pathPrefix,
        parentStates: linkageStateContext.parentLinkageStates,
        ownStates: ownLinkageStates,
        merged,
      });
    }
    return merged;
  }
  return ownLinkageStates;
}, [linkageStateContext?.parentLinkageStates, ownLinkageStates, pathPrefix]);
```

**è¯´æ˜**ï¼š

- **è®¡ç®—è‡ªå·±çš„çŠ¶æ€**ï¼šä½¿ç”¨ `useArrayLinkageManager` è®¡ç®—å½“å‰å±‚çº§çš„è”åŠ¨
- **åˆå¹¶çŠ¶æ€**ï¼šçˆ¶çº§çŠ¶æ€ + è‡ªå·±çš„çŠ¶æ€ï¼Œç¡®ä¿å®Œæ•´çš„è”åŠ¨æ•ˆæœ
- **è°ƒè¯•æ—¥å¿—**ï¼šå¼€å‘ç¯å¢ƒä¸‹è¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•

#### æ­¥éª¤ 5ï¼šæ¸²æŸ“å­—æ®µå¹¶ä¼ é€’ Context

```typescript
const renderFields = () => {
  const fieldsContent = (
    <div className="dynamic-form__fields">
      {fields.map(field => {
        const linkageState = linkageStates[field.name];

        // ä½¿ç”¨ç»Ÿä¸€çš„è·¯å¾„å·¥å…·æ£€æŸ¥å­—æ®µæ˜¯å¦è¢«éšè—
        if (isFieldHiddenByLinkage(field.name, linkageStates)) {
          return null;
        }

        return (
          <FormField
            key={field.name}
            field={field}
            disabled={disabled || field.disabled || loading || linkageState?.disabled}
            readonly={readonly || field.readonly || linkageState?.readonly}
            widgets={stableWidgets}
            linkageState={linkageState}
            layout={layout}
            labelWidth={labelWidth}
          />
        );
      })}
    </div>
  );

  // å¦‚æœä¸æ˜¯åµŒå¥—è¡¨å•ï¼Œæä¾› LinkageStateContext
  if (!asNestedForm) {
    return (
      <LinkageStateProvider
        value={{
          parentLinkageStates: linkageStates,
          form: methods,
          rootSchema: schema,
          pathPrefix: pathPrefix,
          linkageFunctions: effectiveLinkageFunctions,
        }}
      >
        {fieldsContent}
      </LinkageStateProvider>
    );
  }

  return fieldsContent;
};
```

**è¯´æ˜**ï¼š

- **åº”ç”¨è”åŠ¨çŠ¶æ€**ï¼šæ ¹æ® `linkageState` æ§åˆ¶å­—æ®µçš„æ˜¾ç¤ºã€ç¦ç”¨ã€åªè¯»
- **ä¼ é€’ Context**ï¼šæ ¹ DynamicForm é€šè¿‡ Provider ä¼ é€’çŠ¶æ€ç»™å­çº§
- **åµŒå¥—è¡¨å•å¤„ç†**ï¼šå­çº§ä¸å†åˆ›å»ºæ–°çš„ Providerï¼Œç›´æ¥ä½¿ç”¨çˆ¶çº§çš„ Context

### 6.7 ä¾èµ–å›¾ä¼˜åŒ–ï¼ˆDAGï¼‰

**å®é™…å®ç°**ï¼š`src/utils/dependencyGraph.ts`

ä¾èµ–å›¾ç”¨äºä¼˜åŒ–è”åŠ¨å­—æ®µçš„æ›´æ–°é¡ºåºå’Œæ€§èƒ½ã€‚

**å…³é”®ç‰¹æ€§**ï¼š

- âœ… ç²¾ç¡®è®¡ç®—å—å½±å“çš„å­—æ®µ
- âœ… å¾ªç¯ä¾èµ–æ£€æµ‹
- âœ… æ”¯æŒæ‹“æ‰‘æ’åº

### 6.8 å¼‚æ­¥å‡½æ•°æ”¯æŒ

è”åŠ¨ç³»ç»Ÿå®Œæ•´æ”¯æŒå¼‚æ­¥å‡½æ•°ï¼Œé€‚ç”¨äºéœ€è¦è°ƒç”¨ APIã€æ‰§è¡Œå¼‚æ­¥è®¡ç®—ç­‰åœºæ™¯ã€‚

**ç¤ºä¾‹**ï¼š

```typescript
const linkageFunctions = {
  fetchProvinceOptions: async (formData: any) => {
    const response = await fetch(`/api/provinces?country=${formData.country}`);
    const data = await response.json();
    return data.provinces;
  },
};
```

### 6.9 å¼‚æ­¥ç«æ€æ¡ä»¶å¤„ç†

**é—®é¢˜æè¿°**ï¼š

å½“ç”¨æˆ·å¿«é€Ÿåˆ‡æ¢ä¾èµ–å­—æ®µæ—¶ï¼Œå¼‚æ­¥è”åŠ¨å‡½æ•°å¯èƒ½ä¼šå‡ºç°ç«æ€æ¡ä»¶ï¼ˆRace Conditionï¼‰ï¼š

```
ç”¨æˆ·æ“ä½œï¼š
1. é€‰æ‹© "laptop" â†’ å‘èµ·è¯·æ±‚ A
2. å¿«é€Ÿåˆ‡æ¢åˆ° "smartphone" â†’ å‘èµ·è¯·æ±‚ B
3. è¯·æ±‚ B å…ˆè¿”å› â†’ æ›´æ–° schema
4. è¯·æ±‚ A åè¿”å› â†’ é”™è¯¯åœ°è¦†ç›–äº† schema âŒ
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

ç³»ç»Ÿä½¿ç”¨ **è¯·æ±‚åºåˆ—å·ç®¡ç†å™¨ï¼ˆAsyncSequenceManagerï¼‰** è‡ªåŠ¨å¤„ç†å¼‚æ­¥ç«æ€æ¡ä»¶ã€‚

**å®ç°åŸç†**ï¼š

```typescript
/**
 * å¼‚æ­¥è¯·æ±‚åºåˆ—å·ç®¡ç†å™¨
 */
class AsyncSequenceManager {
  private sequences: Map<string, number> = new Map();

  // ä¸ºå­—æ®µç”Ÿæˆæ–°çš„åºåˆ—å·
  next(fieldName: string): number {
    const current = this.sequences.get(fieldName) || 0;
    const next = current + 1;
    this.sequences.set(fieldName, next);
    return next;
  }

  // æ£€æŸ¥åºåˆ—å·æ˜¯å¦æ˜¯æœ€æ–°çš„
  isLatest(fieldName: string, sequence: number): boolean {
    const current = this.sequences.get(fieldName) || 0;
    return sequence === current;
  }
}
```

**å·¥ä½œæµç¨‹**ï¼š

```typescript
// åœ¨è°ƒç”¨å¼‚æ­¥å‡½æ•°ä¹‹å‰ç”Ÿæˆåºåˆ—å·
const sequence = asyncSequenceManager.next(fieldPath); // ä¾‹å¦‚: 1

// æ‰§è¡Œå¼‚æ­¥å‡½æ•°
const fnResult = await fn(formData, context);

// å¼‚æ­¥å‡½æ•°è¿”å›åï¼Œæ£€æŸ¥åºåˆ—å·æ˜¯å¦ä»ç„¶æ˜¯æœ€æ–°çš„
if (!asyncSequenceManager.isLatest(fieldPath, sequence)) {
  // å¦‚æœä¸æ˜¯æœ€æ–°çš„ï¼Œè¯´æ˜ç”¨æˆ·åˆè§¦å‘äº†æ–°çš„è¯·æ±‚
  // ä¸¢å¼ƒè¿™ä¸ªè¿‡æœŸçš„ç»“æœ
  return {};
}

// åªæœ‰æœ€æ–°çš„ç»“æœæ‰ä¼šè¢«åº”ç”¨
result.schema = fnResult;
```

**æ•ˆæœ**ï¼š

```
ç”¨æˆ·æ“ä½œï¼š
1. é€‰æ‹© "laptop" â†’ ç”Ÿæˆåºåˆ—å· 1ï¼Œå‘èµ·è¯·æ±‚ A
2. å¿«é€Ÿåˆ‡æ¢åˆ° "smartphone" â†’ ç”Ÿæˆåºåˆ—å· 2ï¼Œå‘èµ·è¯·æ±‚ B
3. è¯·æ±‚ B å…ˆè¿”å› â†’ æ£€æŸ¥åºåˆ—å· 2 æ˜¯æœ€æ–°çš„ âœ… â†’ æ›´æ–° schema
4. è¯·æ±‚ A åè¿”å› â†’ æ£€æŸ¥åºåˆ—å· 1 ä¸æ˜¯æœ€æ–°çš„ âŒ â†’ ä¸¢å¼ƒç»“æœ
```

**é€‚ç”¨èŒƒå›´**ï¼š

è¿™ä¸ªæ–¹æ¡ˆå¯¹æ‰€æœ‰ä½¿ç”¨å¼‚æ­¥è”åŠ¨å‡½æ•°çš„åœºæ™¯éƒ½æœ‰æ•ˆï¼š
- `schema` è”åŠ¨ï¼ˆå¼‚æ­¥åŠ è½½ schemaï¼‰
- `options` è”åŠ¨ï¼ˆå¼‚æ­¥åŠ è½½é€‰é¡¹ï¼‰
- `value` è”åŠ¨ï¼ˆå¼‚æ­¥è®¡ç®—å€¼ï¼‰
- å…¶ä»–ä»»ä½•ä½¿ç”¨å¼‚æ­¥å‡½æ•°çš„è”åŠ¨ç±»å‹

---

## 7. å®Œæ•´çš„ç«¯åˆ°ç«¯ç¤ºä¾‹

### 7.1 åœºæ™¯æè¿°

å®ç°ä¸€ä¸ªè®¢å•è¡¨å•ï¼ŒåŒ…å«ä»¥ä¸‹åŠŸèƒ½ï¼š

1. æ ¹æ®ç”¨æˆ·ç±»å‹æ˜¾ç¤ºä¸åŒçš„æŠ˜æ‰£å­—æ®µ
2. è‡ªåŠ¨è®¡ç®—æ€»ä»·
3. åŠ¨æ€åŠ è½½çœä»½é€‰é¡¹
4. æ”¯æŒå¤šä¸ªå•†å“é¡¹

### 7.2 Schema å®šä¹‰

```typescript
const orderSchema = {
  type: 'object',
  properties: {
    // ç”¨æˆ·ç±»å‹
    userType: {
      type: 'string',
      title: 'ç”¨æˆ·ç±»å‹',
      enum: ['individual', 'company'],
      enumNames: ['ä¸ªäºº', 'ä¼ä¸š'],
      default: 'individual',
    },

    // ä¼ä¸šæŠ˜æ‰£ï¼ˆä»…ä¼ä¸šç”¨æˆ·æ˜¾ç¤ºï¼‰
    companyDiscount: {
      type: 'number',
      title: 'ä¼ä¸šæŠ˜æ‰£ï¼ˆ%ï¼‰',
      minimum: 0,
      maximum: 50,
      ui: {
        linkage: {
          type: 'visibility',
          dependencies: ['#/properties/userType'],
          when: {
            field: '#/properties/userType',
            operator: '==',
            value: 'company',
          },
          fulfill: {
            state: { visible: true },
          },
          otherwise: {
            state: { visible: false },
          },
        },
      },
    },

    // é…é€åœ°å€
    country: {
      type: 'string',
      title: 'å›½å®¶',
      enum: ['china', 'usa'],
      enumNames: ['ä¸­å›½', 'ç¾å›½'],
    },

    province: {
      type: 'string',
      title: 'çœä»½/å·',
      ui: {
        linkage: {
          type: 'options',
          dependencies: ['#/properties/country'],
          fulfill: {
            function: 'loadProvinceOptions',
          },
        },
      },
    },

    // å•†å“åˆ—è¡¨
    items: {
      type: 'array',
      title: 'å•†å“åˆ—è¡¨',
      minItems: 1,
      items: {
        type: 'object',
        properties: {
          productName: {
            type: 'string',
            title: 'å•†å“åç§°',
          },
          price: {
            type: 'number',
            title: 'å•ä»·',
            minimum: 0,
          },
          quantity: {
            type: 'integer',
            title: 'æ•°é‡',
            minimum: 1,
            default: 1,
          },
          subtotal: {
            type: 'number',
            title: 'å°è®¡',
            ui: {
              readonly: true,
              linkage: {
                type: 'value',
                dependencies: ['./price', './quantity'],
                fulfill: {
                  function: 'calculateSubtotal',
                },
              },
            },
          },
        },
        required: ['productName', 'price', 'quantity'],
      },
    },

    // æ€»ä»·ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰
    totalAmount: {
      type: 'number',
      title: 'æ€»ä»·',
      ui: {
        readonly: true,
        linkage: {
          type: 'value',
          dependencies: ['#/properties/items', '#/properties/companyDiscount'],
          fulfill: {
            function: 'calculateTotal',
          },
        },
      },
    },
  },
  required: ['userType', 'country', 'province', 'items'],
};
```

### 7.3 è”åŠ¨å‡½æ•°å®ç°

```typescript
const linkageFunctions = {
  /**
   * å¼‚æ­¥åŠ è½½çœä»½é€‰é¡¹
   */
  loadProvinceOptions: async (formData: any) => {
    const { country } = formData;

    if (!country) {
      return [];
    }

    try {
      // æ¨¡æ‹Ÿ API è°ƒç”¨
      const response = await fetch(`/api/provinces?country=${country}`);
      const data = await response.json();
      return data.provinces;
    } catch (error) {
      console.error('åŠ è½½çœä»½å¤±è´¥:', error);

      // é™çº§æ–¹æ¡ˆï¼šè¿”å›é™æ€æ•°æ®
      if (country === 'china') {
        return [
          { label: 'åŒ—äº¬', value: 'beijing' },
          { label: 'ä¸Šæµ·', value: 'shanghai' },
          { label: 'å¹¿ä¸œ', value: 'guangdong' },
        ];
      } else if (country === 'usa') {
        return [
          { label: 'California', value: 'ca' },
          { label: 'New York', value: 'ny' },
          { label: 'Texas', value: 'tx' },
        ];
      }
      return [];
    }
  },

  /**
   * è®¡ç®—å•†å“å°è®¡
   */
  calculateSubtotal: (formData: any, context?: LinkageFunctionContext) => {
    // context.fieldPath ç¤ºä¾‹: 'items.0.subtotal'
    // éœ€è¦è·å–åŒä¸€æ•°ç»„å…ƒç´ çš„ price å’Œ quantity

    if (!context?.arrayPath || context.arrayIndex === undefined) {
      return 0;
    }

    const item = formData[context.arrayPath]?.[context.arrayIndex];
    if (!item) {
      return 0;
    }

    const price = item.price || 0;
    const quantity = item.quantity || 0;
    return price * quantity;
  },

  /**
   * è®¡ç®—è®¢å•æ€»ä»·
   */
  calculateTotal: (formData: any) => {
    const { items = [], companyDiscount = 0, userType } = formData;

    // è®¡ç®—æ‰€æœ‰å•†å“çš„å°è®¡æ€»å’Œ
    const subtotal = items.reduce((sum: number, item: any) => {
      const price = item.price || 0;
      const quantity = item.quantity || 0;
      return sum + price * quantity;
    }, 0);

    // åº”ç”¨ä¼ä¸šæŠ˜æ‰£
    if (userType === 'company' && companyDiscount > 0) {
      return subtotal * (1 - companyDiscount / 100);
    }

    return subtotal;
  },
};
```

### 7.4 ç»„ä»¶ä½¿ç”¨

```typescript
import { DynamicForm } from '@/components/DynamicForm';

function OrderForm() {
  const handleSubmit = (data: any) => {
    console.log('æäº¤è®¢å•:', data);
    // å‘é€åˆ°åç«¯ API
  };

  return (
    <DynamicForm
      schema={orderSchema}
      linkageFunctions={linkageFunctions}
      onSubmit={handleSubmit}
      defaultValues={{
        userType: 'individual',
        country: 'china',
        items: [
          {
            productName: 'å•†å“A',
            price: 100,
            quantity: 2
          }
        ]
      }}
    />
  );
}
```

### 7.5 è¿è¡Œæ•ˆæœ

**åˆå§‹çŠ¶æ€**ï¼ˆç”¨æˆ·ç±»å‹ï¼šä¸ªäººï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·ç±»å‹: [ä¸ªäºº â–¼]                  â”‚
â”‚ å›½å®¶: [ä¸­å›½ â–¼]                      â”‚
â”‚ çœä»½/å·: [åŒ—äº¬ â–¼]                   â”‚
â”‚                                     â”‚
â”‚ å•†å“åˆ—è¡¨:                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ å•†å“åç§°: [å•†å“A]               â”‚ â”‚
â”‚ â”‚ å•ä»·: [100]                     â”‚ â”‚
â”‚ â”‚ æ•°é‡: [2]                       â”‚ â”‚
â”‚ â”‚ å°è®¡: 200 (åªè¯»ï¼Œè‡ªåŠ¨è®¡ç®—)      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚ æ€»ä»·: 200 (åªè¯»ï¼Œè‡ªåŠ¨è®¡ç®—)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åˆ‡æ¢ä¸ºä¼ä¸šç”¨æˆ·å**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·ç±»å‹: [ä¼ä¸š â–¼]                  â”‚
â”‚ ä¼ä¸šæŠ˜æ‰£(%): [10]  â† æ–°æ˜¾ç¤ºçš„å­—æ®µ   â”‚
â”‚ å›½å®¶: [ä¸­å›½ â–¼]                      â”‚
â”‚ çœä»½/å·: [åŒ—äº¬ â–¼]                   â”‚
â”‚                                     â”‚
â”‚ å•†å“åˆ—è¡¨:                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ å•†å“åç§°: [å•†å“A]               â”‚ â”‚
â”‚ â”‚ å•ä»·: [100]                     â”‚ â”‚
â”‚ â”‚ æ•°é‡: [2]                       â”‚ â”‚
â”‚ â”‚ å°è®¡: 200                       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚ æ€»ä»·: 180 (åº”ç”¨10%æŠ˜æ‰£å)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.6 è”åŠ¨æ‰§è¡Œæµç¨‹

**åœºæ™¯ 1ï¼šç”¨æˆ·åˆ‡æ¢ç”¨æˆ·ç±»å‹**

```
ç”¨æˆ·æ“ä½œ: é€‰æ‹© "ä¼ä¸š"
    â†“
watch ç›‘å¬åˆ° userType å˜åŒ–
    â†“
dependencyGraph.getAffectedFields('userType')
    â†’ è¿”å›: ['companyDiscount', 'totalAmount']
    â†“
å¹¶è¡Œè®¡ç®—è”åŠ¨çŠ¶æ€:
    â”œâ”€ companyDiscount:
    â”‚   â”œâ”€ æ±‚å€¼ when æ¡ä»¶: userType == 'company' â†’ true
    â”‚   â”œâ”€ åº”ç”¨ fulfill.state: { visible: true }
    â”‚   â””â”€ ç»“æœ: å­—æ®µæ˜¾ç¤º
    â”‚
    â””â”€ totalAmount:
        â”œâ”€ è°ƒç”¨ calculateTotal(formData)
        â”œâ”€ è®¡ç®—: 200 * (1 - 10/100) = 180
        â”œâ”€ è°ƒç”¨ form.setValue('totalAmount', 180)
        â””â”€ ç»“æœ: å­—æ®µå€¼æ›´æ–°ä¸º 180
```

**åœºæ™¯ 2ï¼šç”¨æˆ·ä¿®æ”¹å•†å“æ•°é‡**

```
ç”¨æˆ·æ“ä½œ: å°†æ•°é‡ä» 2 æ”¹ä¸º 3
    â†“
watch ç›‘å¬åˆ° items.0.quantity å˜åŒ–
    â†“
dependencyGraph.getAffectedFields('items.0.quantity')
    â†’ è¿”å›: ['items.0.subtotal', 'totalAmount']
    â†“
å¹¶è¡Œè®¡ç®—è”åŠ¨çŠ¶æ€:
    â”œâ”€ items.0.subtotal:
    â”‚   â”œâ”€ è°ƒç”¨ calculateSubtotal(formData, context)
    â”‚   â”‚   context = {
    â”‚   â”‚     fieldPath: 'items.0.subtotal',
    â”‚   â”‚     arrayPath: 'items',
    â”‚   â”‚     arrayIndex: 0
    â”‚   â”‚   }
    â”‚   â”œâ”€ è®¡ç®—: 100 * 3 = 300
    â”‚   â”œâ”€ è°ƒç”¨ form.setValue('items.0.subtotal', 300)
    â”‚   â””â”€ ç»“æœ: å°è®¡æ›´æ–°ä¸º 300
    â”‚
    â””â”€ totalAmount:
        â”œâ”€ è°ƒç”¨ calculateTotal(formData)
        â”œâ”€ è®¡ç®—: 300 * (1 - 10/100) = 270
        â”œâ”€ è°ƒç”¨ form.setValue('totalAmount', 270)
        â””â”€ ç»“æœ: æ€»ä»·æ›´æ–°ä¸º 270
```

### 7.7 å…³é”®è¦ç‚¹æ€»ç»“

---

## 8. ç‰¹æ®Šåœºæ™¯

### 8.1 æ•°ç»„å­—æ®µè”åŠ¨

æ•°ç»„å­—æ®µçš„è”åŠ¨æ¶‰åŠç›¸å¯¹è·¯å¾„ã€åŠ¨æ€ç´¢å¼•ç­‰å¤æ‚åœºæ™¯ã€‚

**å¿«é€Ÿç¤ºä¾‹**ï¼š

```typescript
{
  contacts: {
    type: 'array',
    items: {
      properties: {
        type: { type: 'string', enum: ['personal', 'work'] },
        companyName: {
          type: 'string',
          ui: {
            linkage: {
              type: 'visibility',
              dependencies: ['./type'],
              when: { field: './type', operator: '==', value: 'work' }
            }
          }
        }
      }
    }
  }
}
```

**è¯¦ç»†æ–‡æ¡£**ï¼š[æ•°ç»„å­—æ®µè”åŠ¨è®¾è®¡æ–¹æ¡ˆ](./ARRAY_FIELD_LINKAGE.md)

### 8.2 è·¯å¾„é€æ˜åŒ–åœºæ™¯

å½“ä½¿ç”¨ `flattenPath` æ—¶ï¼Œè”åŠ¨é…ç½®ä¸­çš„è·¯å¾„ä¼šè‡ªåŠ¨å¤„ç† `~~` åˆ†éš”ç¬¦ã€‚

**è¯¦ç»†æ–‡æ¡£**ï¼š[å­—æ®µè·¯å¾„é€æ˜åŒ–è®¾è®¡æ–¹æ¡ˆ](./FIELD_PATH_FLATTENING.md)

---

## 9. è®¾è®¡æ€»ç»“

### 9.1 èŒè´£åˆ†ç¦»

| å±‚é¢                | è´Ÿè´£å†…å®¹     | å®ç°æ–¹å¼                              |
| ------------------- | ------------ | ------------------------------------- |
| **JSON Schema**     | æ•°æ®éªŒè¯     | `required`, `minLength`, `pattern` ç­‰ |
| **UI æ‰©å±•**         | UI è”åŠ¨é€»è¾‘  | `visibility`, `disabled`, `value` ç­‰  |
| **react-hook-form** | è¡¨å•çŠ¶æ€ç®¡ç† | `watch`, `setValue`, `getValues`      |

### 9.2 æ ¸å¿ƒä¼˜åŠ¿

1. **èŒè´£æ¸…æ™°**ï¼šéªŒè¯é€»è¾‘å’Œ UI é€»è¾‘åˆ†ç¦»
2. **æ ‡å‡†å…¼å®¹**ï¼šéµå¾ª JSON Schema æ ‡å‡†
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šä¾èµ–å›¾ + å¹¶è¡Œè®¡ç®— + ç²¾ç¡®æ›´æ–°
4. **ç±»å‹å®‰å…¨**ï¼šå®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
5. **æ˜“äºæ‰©å±•**ï¼šæ”¯æŒè‡ªå®šä¹‰è”åŠ¨å‡½æ•°
6. **å¼‚æ­¥æ”¯æŒ**ï¼šå®Œæ•´æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥è”åŠ¨å‡½æ•°
7. **ç«æ€æ¡ä»¶å¤„ç†**ï¼šè‡ªåŠ¨å¤„ç†å¼‚æ­¥è¯·æ±‚çš„ç«æ€æ¡ä»¶ï¼Œç¡®ä¿ç»“æœæ­£ç¡®æ€§
8. **åŠ¨æ€ Schema**ï¼šæ”¯æŒåŸºäºè¡¨å•æ•°æ®å¼‚æ­¥åŠ è½½ schema ç»“æ„
9. **åˆ†å±‚è®¡ç®—**ï¼šåµŒå¥—è¡¨å•è‡ªåŠ¨åˆ†å±‚ï¼Œé¿å…é‡å¤è®¡ç®—
10. **è·¯å¾„é€æ˜åŒ–**ï¼šè‡ªåŠ¨å¤„ç† flattenPath åœºæ™¯

---

## 10. å¼‚æ­¥è”åŠ¨çš„é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 10.1 å¼‚æ­¥è”åŠ¨æ¦‚è¿°

å¼‚æ­¥è”åŠ¨æ˜¯åŠ¨æ€è¡¨å•ç³»ç»Ÿçš„é‡è¦ç‰¹æ€§ï¼Œå…è®¸è”åŠ¨å‡½æ•°æ‰§è¡Œå¼‚æ­¥æ“ä½œï¼ˆå¦‚ API è°ƒç”¨ã€å¤æ‚è®¡ç®—ç­‰ï¼‰ã€‚ç„¶è€Œï¼Œå¼‚æ­¥è”åŠ¨å¼•å…¥äº†å¤šä¸ªå¤æ‚çš„é—®é¢˜ï¼Œéœ€è¦ä»”ç»†å¤„ç†ã€‚

**æœ¬ç« å†…å®¹ç»“æ„**ï¼š

- **10.2 é—®é¢˜ 1ï¼šç«æ€æ¡ä»¶** - ç”¨æˆ·å¿«é€Ÿåˆ‡æ¢å¯¼è‡´æ—§è¯·æ±‚è¦†ç›–æ–°è¯·æ±‚
- **10.3 é—®é¢˜ 2ï¼šä¸²è¡Œä¾èµ–ä¸­çš„å¼‚æ­¥æ‰§è¡Œ** - B ä¾èµ– Aï¼ŒC ä¾èµ– B æ—¶çš„æ‰§è¡Œé¡ºåºé—®é¢˜
- **10.4 é—®é¢˜ 3ï¼šsetValue è§¦å‘ watch çš„è¿é”ååº”** - å€¼è”åŠ¨è§¦å‘æ–°çš„ watch å¯¼è‡´çš„é—®é¢˜
- **10.5 ç»¼åˆå®æ–½å»ºè®®** - çŸ­æœŸã€ä¸­æœŸã€é•¿æœŸçš„å®æ–½è·¯çº¿å›¾
- **10.6 å¼€å‘è€…æ³¨æ„äº‹é¡¹** - ä½¿ç”¨å¼‚æ­¥è”åŠ¨æ—¶çš„æœ€ä½³å®è·µ

**é—®é¢˜ä¸¥é‡ç¨‹åº¦**ï¼š

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | å½“å‰çŠ¶æ€ | å½±å“èŒƒå›´ |
|------|---------|---------|---------|
| ç«æ€æ¡ä»¶ | âš ï¸ ä¸­ | âœ… å·²è§£å†³ | æ‰€æœ‰å¼‚æ­¥è”åŠ¨ |
| ä¸²è¡Œä¾èµ–æ‰§è¡Œ | ğŸ”´ é«˜ | âŒ å­˜åœ¨é—®é¢˜ | ä¸²è¡Œä¾èµ–çš„å¼‚æ­¥è”åŠ¨ |
| setValue è§¦å‘ watch | âš ï¸ ä¸­ | âœ… éƒ¨åˆ†ç¼“è§£ | å€¼è”åŠ¨ï¼ˆtype: 'value'ï¼‰ |

---

### 10.2 é—®é¢˜ 1ï¼šç«æ€æ¡ä»¶ï¼ˆRace Conditionï¼‰

#### 10.2.1 é—®é¢˜æè¿°

å½“ç”¨æˆ·å¿«é€Ÿåˆ‡æ¢ä¾èµ–å­—æ®µæ—¶ï¼Œå¼‚æ­¥è”åŠ¨å‡½æ•°å¯èƒ½ä¼šå‡ºç°ç«æ€æ¡ä»¶ï¼š

```
ç”¨æˆ·æ“ä½œï¼š
1. é€‰æ‹© "laptop" â†’ å‘èµ·è¯·æ±‚ A
2. å¿«é€Ÿåˆ‡æ¢åˆ° "smartphone" â†’ å‘èµ·è¯·æ±‚ B
3. è¯·æ±‚ B å…ˆè¿”å› â†’ æ›´æ–° schema
4. è¯·æ±‚ A åè¿”å› â†’ é”™è¯¯åœ°è¦†ç›–äº† schema âŒ
```

**é—®é¢˜æ ¹æº**ï¼šå¼‚æ­¥æ“ä½œçš„å®Œæˆé¡ºåºä¸ç¡®å®šï¼Œå¯èƒ½å¯¼è‡´æ—§çš„ç»“æœè¦†ç›–æ–°çš„ç»“æœã€‚

---

#### 10.2.2 åœºæ™¯ç¤ºä¾‹

**åœºæ™¯**ï¼šåŠ¨æ€åŠ è½½äº§å“é…ç½® schema

```typescript
const linkageFunctions = {
  loadProductSchema: async (formData: any) => {
    const productType = formData?.productType;

    // æ¨¡æ‹Ÿ API è°ƒç”¨ï¼ˆè€—æ—¶ä¸ç¡®å®šï¼‰
    const response = await fetch(`/api/products/${productType}/schema`);
    const schema = await response.json();

    return schema;
  },
};
```

**é—®é¢˜æ¼”ç¤º**ï¼š

```
t0: ç”¨æˆ·é€‰æ‹© "laptop"
  â†’ å‘èµ·è¯·æ±‚ Aï¼ˆè€—æ—¶ 200msï¼‰

t1: ç”¨æˆ·å¿«é€Ÿåˆ‡æ¢åˆ° "smartphone"ï¼ˆ50ms åï¼‰
  â†’ å‘èµ·è¯·æ±‚ Bï¼ˆè€—æ—¶ 100msï¼‰

t2: è¯·æ±‚ B å®Œæˆï¼ˆ150msï¼‰
  â†’ æ˜¾ç¤º smartphone çš„ schema âœ…

t3: è¯·æ±‚ A å®Œæˆï¼ˆ200msï¼‰
  â†’ é”™è¯¯åœ°æ˜¾ç¤º laptop çš„ schema âŒ
  â†’ ç”¨æˆ·çœ‹åˆ°çš„æ˜¯é”™è¯¯çš„é…ç½®ï¼
```

---

#### 10.2.3 å½“å‰è§£å†³æ–¹æ¡ˆï¼šAsyncSequenceManager

ç³»ç»Ÿä½¿ç”¨**è¯·æ±‚åºåˆ—å·ç®¡ç†å™¨**è‡ªåŠ¨å¤„ç†å¼‚æ­¥ç«æ€æ¡ä»¶ã€‚

**å®ç°åŸç†**ï¼š

```typescript
class AsyncSequenceManager {
  private sequences: Map<string, number> = new Map();

  // ä¸ºå­—æ®µç”Ÿæˆæ–°çš„åºåˆ—å·
  next(fieldName: string): number {
    const current = this.sequences.get(fieldName) || 0;
    const next = current + 1;
    this.sequences.set(fieldName, next);
    return next;
  }

  // æ£€æŸ¥åºåˆ—å·æ˜¯å¦æ˜¯æœ€æ–°çš„
  isLatest(fieldName: string, sequence: number): boolean {
    const current = this.sequences.get(fieldName) || 0;
    return sequence === current;
  }
}
```

**å·¥ä½œæµç¨‹**ï¼š

```typescript
// åœ¨è°ƒç”¨å¼‚æ­¥å‡½æ•°ä¹‹å‰ç”Ÿæˆåºåˆ—å·
const sequence = asyncSequenceManager.next(fieldPath); // ä¾‹å¦‚: 1

// æ‰§è¡Œå¼‚æ­¥å‡½æ•°
const fnResult = await fn(formData, context);

// å¼‚æ­¥å‡½æ•°è¿”å›åï¼Œæ£€æŸ¥åºåˆ—å·æ˜¯å¦ä»ç„¶æ˜¯æœ€æ–°çš„
if (!asyncSequenceManager.isLatest(fieldPath, sequence)) {
  console.log(`æ£€æµ‹åˆ°è¿‡æœŸçš„å¼‚æ­¥ç»“æœï¼Œå­—æ®µ: ${fieldPath}, åºåˆ—å·: ${sequence}`);
  // ä¸¢å¼ƒè¿™ä¸ªè¿‡æœŸçš„ç»“æœ
  return {};
}

// åªæœ‰æœ€æ–°çš„ç»“æœæ‰ä¼šè¢«åº”ç”¨
result.schema = fnResult;
```

**æ•ˆæœ**ï¼š

```
t0: ç”¨æˆ·é€‰æ‹© "laptop"
  â†’ ç”Ÿæˆåºåˆ—å· 1ï¼Œå‘èµ·è¯·æ±‚ A

t1: ç”¨æˆ·å¿«é€Ÿåˆ‡æ¢åˆ° "smartphone"
  â†’ ç”Ÿæˆåºåˆ—å· 2ï¼Œå‘èµ·è¯·æ±‚ B

t2: è¯·æ±‚ B å®Œæˆ
  â†’ æ£€æŸ¥åºåˆ—å· 2 æ˜¯æœ€æ–°çš„ âœ…
  â†’ æ›´æ–° schema

t3: è¯·æ±‚ A å®Œæˆ
  â†’ æ£€æŸ¥åºåˆ—å· 1 ä¸æ˜¯æœ€æ–°çš„ âŒ
  â†’ ä¸¢å¼ƒç»“æœ
```

**çŠ¶æ€**ï¼šâœ… å·²è§£å†³

**é€‚ç”¨èŒƒå›´**ï¼šæ‰€æœ‰å¼‚æ­¥è”åŠ¨ç±»å‹ï¼ˆschemaã€optionsã€value ç­‰ï¼‰

---

### 10.3 é—®é¢˜ 2ï¼šä¸²è¡Œä¾èµ–ä¸­çš„å¼‚æ­¥æ‰§è¡Œ

#### 10.3.1 é—®é¢˜æè¿°

åœ¨ä¸²è¡Œä¾èµ–åœºæ™¯ä¸­ï¼ˆä¾‹å¦‚ B ä¾èµ– Aï¼ŒC ä¾èµ– A å’Œ Bï¼‰ï¼Œå½“ A å˜åŒ–æ—¶ï¼Œç³»ç»Ÿåº”è¯¥ï¼š
1. å…ˆè®¡ç®— B çš„è”åŠ¨
2. ç­‰å¾… B å®Œæˆåï¼Œå†è®¡ç®— C çš„è”åŠ¨ï¼ˆä½¿ç”¨æœ€æ–°çš„ B å€¼ï¼‰

ç„¶è€Œï¼Œå½“å‰å®ç°å­˜åœ¨**ä¸¥é‡é—®é¢˜**ï¼š

**å­é—®é¢˜ 1ï¼šå¹¶è¡Œæ‰§è¡Œè€Œéä¸²è¡Œ**

è™½ç„¶ä»£ç ä½¿ç”¨äº† `for...await` å¾ªç¯è¿›è¡Œæ‹“æ‰‘æ’åºï¼Œä½† B çš„ `setValue` ä¼šè§¦å‘æ–°çš„ watch å›è°ƒï¼Œå¯¼è‡´å¤šä¸ªå¼‚æ­¥é“¾å¹¶è¡Œæ‰§è¡Œã€‚

**å­é—®é¢˜ 2ï¼šformData å¿«ç…§é™ˆæ—§**

æ¯æ¬¡ watch è§¦å‘æ—¶éƒ½ä¼šåˆ›å»ºæ–°çš„ formData å¿«ç…§ã€‚å³ä½¿ B æ›´æ–°äº† formDataï¼Œåç»­çš„ watch å›è°ƒä½¿ç”¨çš„ä»ç„¶æ˜¯æ—§å¿«ç…§ï¼Œå¯¼è‡´ C ä½¿ç”¨çš„æ˜¯æ—§çš„ B å€¼ã€‚

**å­é—®é¢˜ 3ï¼šæ‰€æœ‰å¼‚æ­¥ç»“æœéƒ½è¿‡æœŸ**

ç”±äºå¿«é€Ÿè¿ç»­è§¦å‘ï¼Œå¼‚æ­¥åºåˆ—å·å¿«é€Ÿé€’å¢ï¼Œæ‰€æœ‰ç»“æœéƒ½è¢«æ ‡è®°ä¸º"è¿‡æœŸ"å¹¶ä¸¢å¼ƒã€‚

---

#### 10.3.2 é—®é¢˜éªŒè¯

é€šè¿‡æµ‹è¯•éªŒè¯ï¼ˆB ä¾èµ– Aï¼ŒC ä¾èµ– A å’Œ Bï¼Œå¿«é€Ÿä¿®æ”¹ A ä¸‰æ¬¡ï¼‰ï¼š

```typescript
// æœŸæœ›ç»“æœï¼ša=4, b=8, c=12
// å®é™…ç»“æœï¼ša=4, b=undefined, c=undefined

// æ‰§è¡Œæ—¥å¿—æ˜¾ç¤ºï¼š
// 1. Bå¼€å§‹è®¡ç®—: a=2
// 2. Cå¼€å§‹è®¡ç®—: a=2, b=0  â† Cä½¿ç”¨çš„æ˜¯æ—§çš„bå€¼(0)
// 3. Bå¼€å§‹è®¡ç®—: a=3      â† ç¬¬äºŒæ¬¡è§¦å‘ï¼Œå¹¶è¡Œæ‰§è¡Œ
// 4. Cå¼€å§‹è®¡ç®—: a=3, b=0  â† Cåˆä½¿ç”¨æ—§çš„bå€¼
// ...
// æ‰€æœ‰å¼‚æ­¥ç»“æœéƒ½è¢«æ ‡è®°ä¸º"è¿‡æœŸ"å¹¶ä¸¢å¼ƒ
```

**ç»“è®º**ï¼šå½“å‰å®ç°æ— æ³•æ­£ç¡®å¤„ç†ä¸²è¡Œä¾èµ–çš„å¼‚æ­¥è”åŠ¨ã€‚

---

#### 10.3.3 è§£å†³æ–¹æ¡ˆå¯¹æ¯”

æˆ‘ä»¬æå‡ºä¸‰ç§è§£å†³æ–¹æ¡ˆï¼š

| ç»´åº¦ | æ–¹æ¡ˆ 1ï¼šé€’å½’è§¦å‘ | æ–¹æ¡ˆ 2ï¼šä»»åŠ¡é˜Ÿåˆ— | æ–¹æ¡ˆ 3ï¼šå…¨å±€æ ‡å¿— |
|------|-----------------|-----------------|-----------------|
| **å®ç°å¤æ‚åº¦** | é«˜ | ä¸­ | ä½ |
| **ä»£ç æ”¹åŠ¨é‡** | å¤§ | ä¸­ | å° |
| **ä¸²è¡Œæ‰§è¡Œ** | âœ… å®Œç¾ | âœ… å®Œç¾ | âœ… å®Œç¾ |
| **å¿«é€Ÿè¿ç»­è¾“å…¥** | âœ… å¤„ç†æœ€æ–° | âœ… é˜Ÿåˆ—å¤„ç† | âŒ å¯èƒ½ä¸¢å¤± |
| **æ€§èƒ½** | ä¸­ï¼ˆé€’å½’å¼€é”€ï¼‰ | ä¸­ï¼ˆé˜Ÿåˆ—å¼€é”€ï¼‰ | é«˜ï¼ˆä¸€æ¬¡æ€§ï¼‰ |
| **formData ä¸€è‡´æ€§** | âœ… å§‹ç»ˆæœ€æ–° | âœ… å§‹ç»ˆæœ€æ–° | âœ… å§‹ç»ˆæœ€æ–° |
| **ç»´æŠ¤æˆæœ¬** | é«˜ | ä¸­ | ä½ |

**æ¨èæ–¹æ¡ˆ**ï¼šæ–¹æ¡ˆ 2ï¼ˆä»»åŠ¡é˜Ÿåˆ—ï¼‰

**æ–¹æ¡ˆ 1ï¼šé€’å½’è§¦å‘**
- æ ¸å¿ƒæ€æƒ³ï¼šB å®Œæˆåä¸»åŠ¨è§¦å‘ C çš„è®¡ç®—ï¼Œè€Œä¸ä¾èµ– setValue è§¦å‘ watch
- ä¼˜ç‚¹ï¼šçœŸæ­£çš„ä¸²è¡Œæ‰§è¡Œ
- ç¼ºç‚¹ï¼šå®ç°å¤æ‚ï¼Œéœ€è¦é€’å½’å¤„ç†ä¾èµ–é“¾

**æ–¹æ¡ˆ 2ï¼šä»»åŠ¡é˜Ÿåˆ—**ï¼ˆæ¨èï¼‰
- æ ¸å¿ƒæ€æƒ³ï¼šå°†æ‰€æœ‰è”åŠ¨è¯·æ±‚æ”¾å…¥é˜Ÿåˆ—ï¼Œç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªè”åŠ¨é“¾åœ¨æ‰§è¡Œ
- ä¼˜ç‚¹ï¼šç®€å•ç›´è§‚ï¼Œè‡ªåŠ¨åˆå¹¶ä»»åŠ¡ï¼Œä¸ä¸¢å¤±ç”¨æˆ·è¾“å…¥
- ç¼ºç‚¹ï¼šéœ€è¦ç»´æŠ¤é˜Ÿåˆ—çŠ¶æ€

**æ–¹æ¡ˆ 3ï¼šå…¨å±€æ ‡å¿—**
- æ ¸å¿ƒæ€æƒ³ï¼šä½¿ç”¨å…¨å±€æ ‡å¿—å¿½ç•¥æ‰§è¡ŒæœŸé—´çš„æ‰€æœ‰ watch è§¦å‘
- ä¼˜ç‚¹ï¼šå®ç°æœ€ç®€å•
- ç¼ºç‚¹ï¼šå¯èƒ½ä¸¢å¤±ç”¨æˆ·åœ¨æ‰§è¡ŒæœŸé—´çš„è¾“å…¥

---
1. å…ˆè®¡ç®— B çš„è”åŠ¨
2. ç­‰å¾… B å®Œæˆåï¼Œå†è®¡ç®— C çš„è”åŠ¨ï¼ˆä½¿ç”¨æœ€æ–°çš„ B å€¼ï¼‰

ç„¶è€Œï¼Œå½“å‰å®ç°å­˜åœ¨**ä¸¥é‡é—®é¢˜**ï¼š

**é—®é¢˜ 1ï¼šå¹¶è¡Œæ‰§è¡Œè€Œéä¸²è¡Œ**

è™½ç„¶ä»£ç ä½¿ç”¨äº† `for...await` å¾ªç¯è¿›è¡Œæ‹“æ‰‘æ’åºï¼Œä½† B çš„ `setValue` ä¼šè§¦å‘æ–°çš„ watch å›è°ƒï¼Œå¯¼è‡´å¤šä¸ªå¼‚æ­¥é“¾å¹¶è¡Œæ‰§è¡Œã€‚

**é—®é¢˜ 2ï¼šformData å¿«ç…§é™ˆæ—§**

æ¯æ¬¡ watch è§¦å‘æ—¶éƒ½ä¼šåˆ›å»ºæ–°çš„ formData å¿«ç…§ã€‚å³ä½¿ B æ›´æ–°äº† formDataï¼Œåç»­çš„ watch å›è°ƒä½¿ç”¨çš„ä»ç„¶æ˜¯æ—§å¿«ç…§ï¼Œå¯¼è‡´ C ä½¿ç”¨çš„æ˜¯æ—§çš„ B å€¼ã€‚

**é—®é¢˜ 3ï¼šæ‰€æœ‰å¼‚æ­¥ç»“æœéƒ½è¿‡æœŸ**

ç”±äºå¿«é€Ÿè¿ç»­è§¦å‘ï¼Œå¼‚æ­¥åºåˆ—å·å¿«é€Ÿé€’å¢ï¼Œæ‰€æœ‰ç»“æœéƒ½è¢«æ ‡è®°ä¸º"è¿‡æœŸ"å¹¶ä¸¢å¼ƒã€‚

---

#### 10.1.2 é—®é¢˜éªŒè¯

é€šè¿‡æµ‹è¯•éªŒè¯ï¼ˆB ä¾èµ– Aï¼ŒC ä¾èµ– A å’Œ Bï¼Œå¿«é€Ÿä¿®æ”¹ A ä¸‰æ¬¡ï¼‰ï¼š

```typescript
// æœŸæœ›ç»“æœï¼ša=4, b=8, c=12
// å®é™…ç»“æœï¼ša=4, b=undefined, c=undefined

// æ‰§è¡Œæ—¥å¿—æ˜¾ç¤ºï¼š
// 1. Bå¼€å§‹è®¡ç®—: a=2
// 2. Cå¼€å§‹è®¡ç®—: a=2, b=0  â† Cä½¿ç”¨çš„æ˜¯æ—§çš„bå€¼(0)
// 3. Bå¼€å§‹è®¡ç®—: a=3      â† ç¬¬äºŒæ¬¡è§¦å‘ï¼Œå¹¶è¡Œæ‰§è¡Œ
// 4. Cå¼€å§‹è®¡ç®—: a=3, b=0  â† Cåˆä½¿ç”¨æ—§çš„bå€¼
// ...
// æ‰€æœ‰å¼‚æ­¥ç»“æœéƒ½è¢«æ ‡è®°ä¸º"è¿‡æœŸ"å¹¶ä¸¢å¼ƒ
```

**ç»“è®º**ï¼šå½“å‰å®ç°æ— æ³•æ­£ç¡®å¤„ç†ä¸²è¡Œä¾èµ–çš„å¼‚æ­¥è”åŠ¨ã€‚

---

#### 10.1.3 è§£å†³æ–¹æ¡ˆå¯¹æ¯”

æˆ‘ä»¬æå‡ºä¸‰ç§è§£å†³æ–¹æ¡ˆï¼š

| ç»´åº¦ | æ–¹æ¡ˆ 1ï¼šé€’å½’è§¦å‘ | æ–¹æ¡ˆ 2ï¼šä»»åŠ¡é˜Ÿåˆ— | æ–¹æ¡ˆ 3ï¼šå…¨å±€æ ‡å¿— |
|------|-----------------|-----------------|-----------------|
| **å®ç°å¤æ‚åº¦** | é«˜ | ä¸­ | ä½ |
| **ä»£ç æ”¹åŠ¨é‡** | å¤§ | ä¸­ | å° |
| **ä¸²è¡Œæ‰§è¡Œ** | âœ… å®Œç¾ | âœ… å®Œç¾ | âœ… å®Œç¾ |
| **å¿«é€Ÿè¿ç»­è¾“å…¥** | âœ… å¤„ç†æœ€æ–° | âœ… é˜Ÿåˆ—å¤„ç† | âŒ å¯èƒ½ä¸¢å¤± |
| **æ€§èƒ½** | ä¸­ï¼ˆé€’å½’å¼€é”€ï¼‰ | ä¸­ï¼ˆé˜Ÿåˆ—å¼€é”€ï¼‰ | é«˜ï¼ˆä¸€æ¬¡æ€§ï¼‰ |
| **formData ä¸€è‡´æ€§** | âœ… å§‹ç»ˆæœ€æ–° | âœ… å§‹ç»ˆæœ€æ–° | âœ… å§‹ç»ˆæœ€æ–° |
| **ç»´æŠ¤æˆæœ¬** | é«˜ | ä¸­ | ä½ |

**æ¨èæ–¹æ¡ˆ**ï¼šæ–¹æ¡ˆ 2ï¼ˆä»»åŠ¡é˜Ÿåˆ—ï¼‰

---

#### 10.1.4 æ¨èæ–¹æ¡ˆï¼šä»»åŠ¡é˜Ÿåˆ—ç®¡ç†

**æ ¸å¿ƒæ€æƒ³**ï¼š

1. å°†æ‰€æœ‰è”åŠ¨è¯·æ±‚æ”¾å…¥é˜Ÿåˆ—
2. ç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªè”åŠ¨é“¾åœ¨æ‰§è¡Œ
3. è‡ªåŠ¨åˆå¹¶ç›¸åŒå­—æ®µçš„ä»»åŠ¡
4. æ¯æ¬¡å¤„ç†æ—¶è·å–æœ€æ–°çš„è¡¨å•æ•°æ®

**ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†å™¨**ï¼š

```typescript
class LinkageTaskQueue {
  private queue: Array<{ fieldName: string; timestamp: number }> = [];
  private isProcessing = false;
  private latestTaskMap = new Map<string, number>();

  // æ·»åŠ ä»»åŠ¡ï¼ˆè‡ªåŠ¨å»é‡å’Œåˆå¹¶ï¼‰
  enqueue(fieldName: string) {
    const timestamp = Date.now();

    // å¦‚æœé˜Ÿåˆ—ä¸­å·²æœ‰ç›¸åŒå­—æ®µçš„ä»»åŠ¡ï¼Œæ›´æ–°æ—¶é—´æˆ³
    const existingIndex = this.queue.findIndex(t => t.fieldName === fieldName);
    if (existingIndex >= 0) {
      this.queue[existingIndex].timestamp = timestamp;
    } else {
      this.queue.push({ fieldName, timestamp });
    }
    this.latestTaskMap.set(fieldName, timestamp);
  }

  dequeue() {
    return this.queue.shift();
  }

  isTaskValid(fieldName: string, timestamp: number) {
    return this.latestTaskMap.get(fieldName) === timestamp;
  }

  isEmpty() {
    return this.queue.length === 0;
  }
}
```

**é˜Ÿåˆ—å¤„ç†å™¨å®ç°**ï¼š

```typescript
async function processQueue() {
  if (taskQueue.getProcessing()) {
    return; // å·²ç»åœ¨å¤„ç†ä¸­
  }

  taskQueue.setProcessing(true);

  try {
    while (!taskQueue.isEmpty()) {
      const task = taskQueue.dequeue();
      if (!task) break;

      // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦ä»ç„¶æœ‰æ•ˆï¼ˆå¯èƒ½è¢«åç»­ä»»åŠ¡æ›¿ä»£ï¼‰
      if (!taskQueue.isTaskValid(task.fieldName, task.timestamp)) {
        continue; // è·³è¿‡è¿‡æœŸä»»åŠ¡
      }

      // è·å–æœ€æ–°çš„è¡¨å•æ•°æ®
      const formData = { ...getValues() };

      // è®¡ç®—å—å½±å“çš„å­—æ®µ
      const affectedFields = dependencyGraph.getAffectedFields(task.fieldName);
      const sortedFields = dependencyGraph.topologicalSort(affectedFields);

      // æŒ‰æ‹“æ‰‘é¡ºåºæ‰§è¡Œ
      for (const fieldName of sortedFields) {
        const linkage = linkages[fieldName];
        if (!linkage) continue;

        const result = await evaluateLinkage({
          linkage,
          formData,
          linkageFunctions,
          fieldPath: fieldName,
          asyncSequenceManager,
        });

        // æ›´æ–°æœ¬åœ° formDataï¼ˆä¾›åç»­å­—æ®µä½¿ç”¨ï¼‰
        if (linkage.type === 'value' && result.value !== undefined) {
          formData[fieldName] = result.value;
        }
      }

      // æ‰¹é‡æ›´æ–°è¡¨å•å’ŒçŠ¶æ€
      updateFormAndStates(sortedFields, formData);
    }
  } finally {
    taskQueue.setProcessing(false);
  }
}
```

**watch é›†æˆ**ï¼š

```typescript
useEffect(() => {
  const subscription = watch((_, { name }) => {
    if (!name) return;

    // é˜²æ­¢æ­»å¾ªç¯
    if (isUpdatingFromLinkage.current) {
      return;
    }

    // è·å–å—å½±å“çš„å­—æ®µ
    const affectedFields = dependencyGraph.getAffectedFields(name);
    if (affectedFields.length === 0) return;

    // å°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—
    taskQueue.enqueue(name);

    // è§¦å‘é˜Ÿåˆ—å¤„ç†
    processQueue();
  });

  return () => subscription.unsubscribe();
}, [watch, linkages, linkageFunctions, dependencyGraph]);
```

---

#### 10.1.5 æ‰§è¡Œæµç¨‹ç¤ºä¾‹

**åœºæ™¯**ï¼šB ä¾èµ– Aï¼ŒC ä¾èµ– A å’Œ Bï¼Œç”¨æˆ·å¿«é€Ÿä¿®æ”¹ A ä¸‰æ¬¡ï¼ˆA=2, A=3, A=4ï¼‰

```
æ—¶é—´çº¿ï¼š
t0: ç”¨æˆ·ä¿®æ”¹ A = 2
t1: ç”¨æˆ·ä¿®æ”¹ A = 3 (50mså)
t2: ç”¨æˆ·ä¿®æ”¹ A = 4 (100mså)

æ‰§è¡Œæµç¨‹ï¼š

t0: A = 2
  â†“
  watch è§¦å‘ â†’ taskQueue.enqueue('a')
  â†“
  processQueue() å¼€å§‹
  â†“
  è®¡ç®— B (ä¾èµ– A)
    - formData = { a: 2, b: 0, c: 0 }
    - await calculateB(formData) â†’ è¿”å› 4
    - formData.b = 4
  â†“
  è®¡ç®— C (ä¾èµ– A, B)
    - formData = { a: 2, b: 4, c: 0 }  â† ä½¿ç”¨æœ€æ–°çš„ B å€¼
    - await calculateC(formData) â†’ è¿”å› 6
    - formData.c = 6
  â†“
  æ‰¹é‡æ›´æ–°è¡¨å•å’ŒçŠ¶æ€
  â†“
  processQueue() å®Œæˆ

t1: A = 3 (åœ¨ B è®¡ç®—æœŸé—´)
  â†“
  watch è§¦å‘ â†’ taskQueue.enqueue('a')
  â†“
  é˜Ÿåˆ—ä¸­å·²æœ‰ 'a'ï¼Œæ›´æ–°æ—¶é—´æˆ³
  â†“
  processQueue() æ­£åœ¨æ‰§è¡Œï¼Œè·³è¿‡

t2: A = 4 (åœ¨ C è®¡ç®—æœŸé—´)
  â†“
  watch è§¦å‘ â†’ taskQueue.enqueue('a')
  â†“
  é˜Ÿåˆ—ä¸­å·²æœ‰ 'a'ï¼Œæ›´æ–°æ—¶é—´æˆ³
  â†“
  processQueue() æ­£åœ¨æ‰§è¡Œï¼Œè·³è¿‡

t3: ç¬¬ä¸€è½®å¤„ç†å®Œæˆ
  â†“
  processQueue() ç»§ç»­å¤„ç†é˜Ÿåˆ—
  â†“
  å–å‡ºä»»åŠ¡ 'a' (æ—¶é—´æˆ³ = t2)
  â†“
  è®¡ç®— B (ä¾èµ– A)
    - formData = { a: 4, b: 4, c: 6 }  â† è·å–æœ€æ–°æ•°æ®
    - await calculateB(formData) â†’ è¿”å› 8
    - formData.b = 8
  â†“
  è®¡ç®— C (ä¾èµ– A, B)
    - formData = { a: 4, b: 8, c: 6 }  â† ä½¿ç”¨æœ€æ–°çš„ B å€¼
    - await calculateC(formData) â†’ è¿”å› 12
    - formData.c = 12
  â†“
  æ‰¹é‡æ›´æ–°è¡¨å•å’ŒçŠ¶æ€
  â†“
  é˜Ÿåˆ—ä¸ºç©ºï¼ŒprocessQueue() å®Œæˆ

æœ€ç»ˆç»“æœï¼š
  a = 4, b = 8, c = 12 âœ…
```

**å…³é”®ç‰¹æ€§**ï¼š

1. âœ… **çœŸæ­£çš„ä¸²è¡Œæ‰§è¡Œ**ï¼šC æ€»æ˜¯ç­‰å¾… B å®Œæˆåæ‰å¼€å§‹è®¡ç®—
2. âœ… **ä½¿ç”¨æœ€æ–°çš„ B å€¼**ï¼šC è®¡ç®—æ—¶ä½¿ç”¨çš„æ˜¯ B çš„æœ€æ–°ç»“æœ
3. âœ… **ä»»åŠ¡åˆå¹¶**ï¼šå¤šæ¬¡ä¿®æ”¹ A ä¼šåˆå¹¶ä¸ºä¸€æ¬¡å¤„ç†
4. âœ… **ä¸ä¸¢å¤±ç”¨æˆ·è¾“å…¥**ï¼šæœ€åä¸€æ¬¡ä¿®æ”¹ï¼ˆA=4ï¼‰ä¼šè¢«æ­£ç¡®å¤„ç†

---

#### 10.1.6 å®æ–½å»ºè®®

**çŸ­æœŸï¼ˆå½“å‰çŠ¶æ€ï¼‰**ï¼š
- âš ï¸ å½“å‰å®ç°å­˜åœ¨ä¸¥é‡é—®é¢˜ï¼Œä¸²è¡Œä¾èµ–çš„å¼‚æ­¥è”åŠ¨æ— æ³•æ­£å¸¸å·¥ä½œ
- âš ï¸ å»ºè®®é¿å…ä½¿ç”¨ä¸²è¡Œä¾èµ–çš„å¼‚æ­¥è”åŠ¨ï¼Œæˆ–ç¡®ä¿è”åŠ¨å‡½æ•°æ˜¯åŒæ­¥çš„

**ä¸­æœŸï¼ˆä¿®å¤é˜¶æ®µï¼‰**ï¼š
- ğŸ”§ å®æ–½ä»»åŠ¡é˜Ÿåˆ—æ–¹æ¡ˆï¼ˆæ–¹æ¡ˆ 2ï¼‰
- ğŸ”§ æ·»åŠ å•å…ƒæµ‹è¯•éªŒè¯ä¸²è¡Œä¾èµ–åœºæ™¯
- ğŸ”§ æ›´æ–°æ–‡æ¡£è¯´æ˜æ–°çš„æ‰§è¡Œæ¨¡å‹

**é•¿æœŸï¼ˆä¼˜åŒ–é˜¶æ®µï¼‰**ï¼š
- è€ƒè™‘æ·»åŠ é˜²æŠ–æœºåˆ¶ï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–æ€§èƒ½
- ä¸ºæ…¢é€Ÿå¼‚æ­¥è”åŠ¨æ·»åŠ  loading çŠ¶æ€æç¤º
- æä¾›é…ç½®é€‰é¡¹ï¼Œè®©å¼€å‘è€…è‡ªå®šä¹‰é˜Ÿåˆ—è¡Œä¸º

---

### 10.2 å€¼è”åŠ¨è§¦å‘ watch çš„æ½œåœ¨é—®é¢˜

#### 10.2.1 é—®é¢˜æè¿°

åœ¨å½“å‰å®ç°ä¸­ï¼Œå€¼è”åŠ¨ï¼ˆ`type: 'value'`ï¼‰å­˜åœ¨ä¸€ä¸ªæ½œåœ¨çš„é—®é¢˜ï¼šå½“å¼‚æ­¥è”åŠ¨å‡½æ•°è®¡ç®—å®Œæˆåï¼Œä¼šè°ƒç”¨ `form.setValue()` æ¥æ›´æ–°è¡¨å•å­—æ®µå€¼ã€‚**å³ä½¿è®¾ç½®äº† `shouldValidate: false` å’Œ `shouldDirty: false`ï¼ŒReact Hook Form çš„ `watch` ä»ç„¶ä¼šè¢«è§¦å‘**ã€‚

è¿™ä¼šå¯¼è‡´ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ï¼š

**é—®é¢˜ Aï¼šsetValue è§¦å‘ watch çš„æ­»å¾ªç¯é£é™©**

åœ¨åŒæ­¥è”åŠ¨å‡½æ•°çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½å¯¼è‡´æ— é™å¾ªç¯ï¼š

```
ç”¨æˆ·ä¿®æ”¹å­—æ®µ A
  â†“
watch è§¦å‘ï¼Œè®¡ç®—å­—æ®µ B çš„è”åŠ¨
  â†“
è°ƒç”¨ setValue(B, newValue)
  â†“
setValue è§¦å‘ watchï¼ˆå³ä½¿è®¾ç½®äº† shouldValidate: falseï¼‰
  â†“
watch å†æ¬¡è§¦å‘ï¼Œé‡æ–°è®¡ç®—å­—æ®µ B
  â†“
æ— é™å¾ªç¯...
```

**é—®é¢˜ Bï¼šæµ‹è¯•ç¯å¢ƒä¸­çš„ watch å¤šæ¬¡è§¦å‘**

åœ¨æµ‹è¯•ç¯å¢ƒä¸­ï¼ŒReact Hook Form çš„ `watch` åœ¨åˆå§‹åŒ–æ—¶ä¼šè§¦å‘å¤šæ¬¡ï¼Œå¯¼è‡´å¼‚æ­¥åºåˆ—å·å¿«é€Ÿé€’å¢ã€‚å½“å¼‚æ­¥å‡½æ•°å®Œæˆæ—¶ï¼Œåºåˆ—å·å·²ç»è¿‡æœŸï¼Œç»“æœè¢«ä¸¢å¼ƒã€‚

---

#### 10.1.2 é—®é¢˜åœºæ™¯ç¤ºä¾‹

**åœºæ™¯ 1ï¼šåŒæ­¥å€¼è”åŠ¨ï¼ˆé—®é¢˜ Aï¼‰**

```typescript
const linkages = {
  total: {
    type: 'value',
    dependencies: ['price', 'quantity'],
    fulfill: {
      function: 'calculateTotal',
    },
  },
};

const linkageFunctions = {
  calculateTotal: (formData: any) => {
    return (formData.price || 0) * (formData.quantity || 0);
  },
};
```

**æ½œåœ¨é—®é¢˜**ï¼š
- ç”¨æˆ·ä¿®æ”¹ `price` â†’ watch è§¦å‘
- è®¡ç®— `total` å¹¶è°ƒç”¨ `setValue('total', newValue)`
- setValue è§¦å‘ watch â†’ å†æ¬¡è®¡ç®— `total`
- å¯èƒ½å¯¼è‡´æ— é™å¾ªç¯

**åœºæ™¯ 2ï¼šå¼‚æ­¥å€¼è”åŠ¨ï¼ˆé—®é¢˜ Bï¼‰**

```typescript
const linkageFunctions = {
  calculateTotal: async (formData: any) => {
    // æ¨¡æ‹Ÿ API è°ƒç”¨
    await new Promise(resolve => setTimeout(resolve, 100));
    return (formData.price || 0) * (formData.quantity || 0);
  },
};
```

**æ½œåœ¨é—®é¢˜**ï¼š
- ç”¨æˆ·ä¿®æ”¹ `price` â†’ watch è§¦å‘ï¼ˆåºåˆ—å· = 1ï¼‰
- å¼‚æ­¥å‡½æ•°å¼€å§‹æ‰§è¡Œ
- åœ¨å¼‚æ­¥å‡½æ•°æ‰§è¡ŒæœŸé—´ï¼ŒsetValue è§¦å‘ watchï¼ˆåºåˆ—å·é€’å¢åˆ° 2ï¼‰
- å½“å¼‚æ­¥å‡½æ•°å®Œæˆæ—¶ï¼Œåºåˆ—å· 1 å·²ç»è¿‡æœŸ
- ç»“æœè¢«ä¸¢å¼ƒï¼Œå­—æ®µå€¼ä¸ä¼šæ›´æ–°

---

#### 10.1.3 å½“å‰çš„ç¼“è§£æªæ–½

**é’ˆå¯¹é—®é¢˜ Aï¼ˆæ­»å¾ªç¯ï¼‰**ï¼š

å½“å‰ä»£ç å·²ç»æ·»åŠ äº†æ ‡å¿—ä½æ¥é˜²æ­¢æ­»å¾ªç¯ï¼š

```typescript
// æ ‡å¿—ä½ï¼šé˜²æ­¢ setValue è§¦å‘çš„ watch å¯¼è‡´æ­»å¾ªç¯
const isUpdatingFromLinkage = useRef(false);

// åœ¨ watch å›è°ƒå¼€å¤´æ£€æŸ¥æ ‡å¿—ä½
if (isUpdatingFromLinkage.current) {
  return;
}

// åœ¨ setValue å‰åè®¾ç½®æ ‡å¿—ä½
isUpdatingFromLinkage.current = true;
try {
  form.setValue(fieldName, result.value, {
    shouldValidate: false,
    shouldDirty: false,
  });
} finally {
  setTimeout(() => {
    isUpdatingFromLinkage.current = false;
  }, 0);
}
```

**çŠ¶æ€**ï¼šâœ… å·²ç¼“è§£ï¼ˆé€šè¿‡æ ‡å¿—ä½é˜²æ­¢é€’å½’è§¦å‘ï¼‰

**é’ˆå¯¹é—®é¢˜ Bï¼ˆæµ‹è¯•ç¯å¢ƒå¤šæ¬¡è§¦å‘ï¼‰**ï¼š

åœ¨æµ‹è¯•ä¸­å¢åŠ ç­‰å¾…æ—¶é—´ï¼Œè®©ç³»ç»Ÿç¨³å®šåå†è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼š

```typescript
// ç­‰å¾…åˆå§‹åŒ–å®Œæˆ
await waitFor(() => {
  expect(result.current.linkageStates.total?.value).toBe(200);
}, { timeout: 5000, interval: 100 });

// ç­‰å¾…æ‰€æœ‰å¼‚æ­¥æ“ä½œå®Œå…¨ç¨³å®šï¼ˆç¡®ä¿ watch ä¸å†è§¦å‘ï¼‰
await new Promise(resolve => setTimeout(resolve, 500));

// ä¿®æ”¹å­—æ®µ
act(() => {
  result.current.form.setValue('price', 150);
});
```

**çŠ¶æ€**ï¼šâœ… å·²ç¼“è§£ï¼ˆé€šè¿‡å¢åŠ ç­‰å¾…æ—¶é—´ï¼‰

---

#### 10.1.4 å®é™…ä½¿ç”¨åœºæ™¯çš„é£é™©è¯„ä¼°

è™½ç„¶æµ‹è¯•ç¯å¢ƒä¸­çš„é—®é¢˜å·²ç»è§£å†³ï¼Œä½†åœ¨**å®é™…ä½¿ç”¨åœºæ™¯**ä¸­ï¼Œä»¥ä¸‹æƒ…å†µå¯èƒ½ä»ç„¶å­˜åœ¨é—®é¢˜ï¼š

**é£é™©åœºæ™¯ 1ï¼šç”¨æˆ·å¿«é€Ÿè¿ç»­è¾“å…¥**

```typescript
// ç”¨æˆ·åœ¨è¾“å…¥æ¡†ä¸­å¿«é€Ÿè¾“å…¥
price: 100 â†’ 150 â†’ 200 â†’ 250
  â†“       â†“     â†“     â†“
watch è§¦å‘ 4 æ¬¡ï¼Œåºåˆ—å·é€’å¢åˆ° 4

å¦‚æœå¼‚æ­¥è”åŠ¨å‡½æ•°æ‰§è¡Œæ—¶é—´è¾ƒé•¿ï¼ˆå¦‚ API è°ƒç”¨ > 500msï¼‰ï¼š
- åºåˆ—å· 1-3 çš„ç»“æœéƒ½ä¼šè¢«æ ‡è®°ä¸º"è¿‡æœŸ"
- åªæœ‰åºåˆ—å· 4 çš„ç»“æœä¼šè¢«åº”ç”¨
- ç”¨æˆ·å¯èƒ½çœ‹åˆ°å­—æ®µå€¼é•¿æ—¶é—´ä¸æ›´æ–°
```

**é£é™©åœºæ™¯ 2ï¼šå¤šä¸ªå­—æ®µåŒæ—¶å˜åŒ–**

```typescript
// ç”¨æˆ·åŒæ—¶ä¿®æ”¹å¤šä¸ªä¾èµ–å­—æ®µ
price: 100 â†’ 150
quantity: 2 â†’ 3

æ¯æ¬¡ä¿®æ”¹éƒ½ä¼šè§¦å‘ watchï¼Œå¯¼è‡´åºåˆ—å·å¿«é€Ÿé€’å¢ï¼š
- price ä¿®æ”¹ â†’ åºåˆ—å· 1
- quantity ä¿®æ”¹ â†’ åºåˆ—å· 2
- å¦‚æœåºåˆ—å· 1 çš„å¼‚æ­¥å‡½æ•°è¿˜æœªå®Œæˆï¼Œç»“æœä¼šè¢«ä¸¢å¼ƒ
```

**é£é™©ç­‰çº§**ï¼š

| åœºæ™¯                                  | é£é™©ç­‰çº§ | è¯´æ˜                                   |
| ------------------------------------- | -------- | -------------------------------------- |
| åŒæ­¥è”åŠ¨å‡½æ•°                          | âœ… ä½    | å·²é€šè¿‡æ ‡å¿—ä½å®Œå…¨ä¿®å¤                   |
| å¿«é€Ÿå¼‚æ­¥è”åŠ¨å‡½æ•°ï¼ˆ< 100msï¼‰           | âš ï¸ ä¸­    | å¤§éƒ¨åˆ†æƒ…å†µä¸‹å¯ä»¥æ­£å¸¸å·¥ä½œ               |
| æ…¢é€Ÿå¼‚æ­¥è”åŠ¨å‡½æ•°ï¼ˆ> 500msï¼‰+ å¿«é€Ÿè¾“å…¥ | âš ï¸ é«˜    | å¯èƒ½å¯¼è‡´å¼‚æ­¥ç»“æœé¢‘ç¹è¿‡æœŸï¼Œç”¨æˆ·ä½“éªŒä¸ä½³ |

---

#### 10.1.5 å»ºè®®çš„è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šæ·»åŠ é˜²æŠ–æœºåˆ¶ï¼ˆæ¨èï¼‰**

ä¸º watch å›è°ƒæ·»åŠ é˜²æŠ–ï¼Œé¿å…å¿«é€Ÿè¿ç»­è§¦å‘ï¼š

```typescript
const debounceTimers = useRef<Map<string, NodeJS.Timeout>>(new Map());

// åœ¨ watch å›è°ƒä¸­
const timer = debounceTimers.current.get(name);
if (timer) {
  clearTimeout(timer);
}

debounceTimers.current.set(name, setTimeout(() => {
  // æ‰§è¡Œè”åŠ¨é€»è¾‘
}, 300)); // 300ms é˜²æŠ–å»¶è¿Ÿ
```

**ä¼˜ç‚¹**ï¼š
- å‡å°‘ä¸å¿…è¦çš„å¼‚æ­¥è°ƒç”¨
- æé«˜æ€§èƒ½
- é¿å…åºåˆ—å·å¿«é€Ÿé€’å¢
- æ”¹å–„ç”¨æˆ·ä½“éªŒï¼ˆç­‰å¾…ç”¨æˆ·è¾“å…¥å®Œæˆåå†è®¡ç®—ï¼‰

**ç¼ºç‚¹**ï¼š
- å¢åŠ äº†å“åº”å»¶è¿Ÿï¼ˆ300msï¼‰
- éœ€è¦ä»”ç»†è°ƒæ•´é˜²æŠ–æ—¶é—´
- å¯¹äºæŸäº›éœ€è¦å®æ—¶å“åº”çš„åœºæ™¯å¯èƒ½ä¸é€‚ç”¨

**é€‚ç”¨åœºæ™¯**ï¼š
- å¼‚æ­¥ API è°ƒç”¨ï¼ˆå¦‚åŠ¨æ€åŠ è½½é€‰é¡¹ã€schemaï¼‰
- å¤æ‚çš„è®¡ç®—é€»è¾‘
- ç”¨æˆ·å¯èƒ½å¿«é€Ÿè¿ç»­è¾“å…¥çš„å­—æ®µ

---

**æ–¹æ¡ˆ 2ï¼šæ”¹è¿›å¼‚æ­¥åºåˆ—ç®¡ç†å™¨**

ä¸ä¸¢å¼ƒ"è¿‡æœŸ"çš„ç»“æœï¼Œè€Œæ˜¯ä½¿ç”¨æœ€æ–°çš„ç»“æœï¼š

```typescript
// ç§»é™¤åºåˆ—å·æ£€æŸ¥ï¼Œç›´æ¥ä½¿ç”¨æœ€æ–°ç»“æœ
// åˆ é™¤è¿™æ®µä»£ç ï¼š
if (!asyncSequenceManager.isLatest(fieldPath, sequence)) {
  console.log(`æ£€æµ‹åˆ°è¿‡æœŸçš„å¼‚æ­¥ç»“æœï¼Œå­—æ®µ: ${fieldPath}`);
  return {};
}
```

**ä¼˜ç‚¹**ï¼š
- ç®€å•ç›´æ¥
- ä¸ä¼šä¸¢å¤±å¼‚æ­¥ç»“æœ
- æ‰€æœ‰å¼‚æ­¥è°ƒç”¨éƒ½ä¼šç”Ÿæ•ˆ

**ç¼ºç‚¹**ï¼š
- å¯èƒ½å¯¼è‡´ç«æ€æ¡ä»¶ï¼ˆæ—§çš„ç»“æœè¦†ç›–æ–°çš„ç»“æœï¼‰
- ä¸é€‚åˆä¾èµ–é¡ºåºæ•æ„Ÿçš„åœºæ™¯
- å¯èƒ½å¯¼è‡´å­—æ®µå€¼"é—ªçƒ"ï¼ˆå…ˆæ˜¾ç¤ºæ—§å€¼ï¼Œå†æ˜¾ç¤ºæ–°å€¼ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- å¼‚æ­¥å‡½æ•°æ‰§è¡Œæ—¶é—´å¾ˆçŸ­ï¼ˆ< 50msï¼‰
- ç»“æœä¸ä¾èµ–äºé¡ºåº
- å¯ä»¥æ¥å—å¶å°”çš„"é—ªçƒ"

---

**æ–¹æ¡ˆ 3ï¼šæ··åˆæ–¹æ¡ˆï¼ˆæœ€ä½³å®è·µï¼‰**

ç»“åˆé˜²æŠ–å’Œåºåˆ—å·ç®¡ç†ï¼š

```typescript
// 1. å¯¹ç”¨æˆ·è¾“å…¥å­—æ®µæ·»åŠ é˜²æŠ–
const debounceConfig = {
  'price': 300,      // ä»·æ ¼è¾“å…¥é˜²æŠ– 300ms
  'quantity': 300,   // æ•°é‡è¾“å…¥é˜²æŠ– 300ms
  'country': 0,      // ä¸‹æ‹‰é€‰æ‹©ä¸é˜²æŠ–
};

// 2. ä¿ç•™åºåˆ—å·ç®¡ç†ï¼Œå¤„ç†å‰©ä½™çš„ç«æ€æ¡ä»¶
// 3. ä¸ºæ…¢é€Ÿå¼‚æ­¥å‡½æ•°æ·»åŠ  loading çŠ¶æ€æç¤º
```

**ä¼˜ç‚¹**ï¼š
- å…¼é¡¾æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ
- çµæ´»é…ç½®ä¸åŒå­—æ®µçš„é˜²æŠ–æ—¶é—´
- ä¿ç•™ç«æ€æ¡ä»¶ä¿æŠ¤

**ç¼ºç‚¹**ï¼š
- å®ç°å¤æ‚åº¦è¾ƒé«˜
- éœ€è¦ç»´æŠ¤é˜²æŠ–é…ç½®

---

#### 10.1.6 å®æ–½å»ºè®®

**çŸ­æœŸï¼ˆå½“å‰çŠ¶æ€ï¼‰**ï¼š
- âœ… å½“å‰çš„ä¿®å¤å·²ç»è¶³å¤Ÿï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨
- âœ… æ ‡å¿—ä½é˜²æ­¢äº†æ­»å¾ªç¯
- âœ… æµ‹è¯•ç¯å¢ƒé—®é¢˜å·²è§£å†³

**ä¸­æœŸï¼ˆç›‘æ§é˜¶æ®µï¼‰**ï¼š
- ç›‘æ§å®é™…ä½¿ç”¨ä¸­æ˜¯å¦å‡ºç°å¼‚æ­¥ç»“æœè¿‡æœŸçš„é—®é¢˜
- æ”¶é›†ç”¨æˆ·åé¦ˆï¼Œç‰¹åˆ«æ˜¯æ…¢é€Ÿç½‘ç»œç¯å¢ƒä¸‹çš„è¡¨ç°
- è®°å½•æ§åˆ¶å°ä¸­"æ£€æµ‹åˆ°è¿‡æœŸçš„å¼‚æ­¥ç»“æœ"çš„é¢‘ç‡

**é•¿æœŸï¼ˆä¼˜åŒ–é˜¶æ®µï¼‰**ï¼š
- å¦‚æœå‘ç°é—®é¢˜é¢‘ç¹å‡ºç°ï¼Œå®æ–½**æ–¹æ¡ˆ 1ï¼ˆé˜²æŠ–æœºåˆ¶ï¼‰**
- ä¸ºæ…¢é€Ÿå¼‚æ­¥è”åŠ¨æ·»åŠ  loading çŠ¶æ€æç¤º
- è€ƒè™‘æä¾›é…ç½®é€‰é¡¹ï¼Œè®©å¼€å‘è€…è‡ªå®šä¹‰é˜²æŠ–æ—¶é—´

---

#### 10.1.7 å¼€å‘è€…æ³¨æ„äº‹é¡¹

å¦‚æœä½ åœ¨ä½¿ç”¨å€¼è”åŠ¨æ—¶é‡åˆ°ä»¥ä¸‹æƒ…å†µï¼Œè¯·è€ƒè™‘å®æ–½é˜²æŠ–ï¼š

1. **å¼‚æ­¥è”åŠ¨å‡½æ•°æ‰§è¡Œæ—¶é—´è¾ƒé•¿**ï¼ˆ> 500msï¼‰
   - ä¾‹å¦‚ï¼šè°ƒç”¨è¿œç¨‹ APIã€å¤æ‚è®¡ç®—

2. **ç”¨æˆ·å¯èƒ½å¿«é€Ÿè¿ç»­è¾“å…¥**
   - ä¾‹å¦‚ï¼šä»·æ ¼ã€æ•°é‡ç­‰æ•°å­—è¾“å…¥æ¡†
   - ä¾‹å¦‚ï¼šæœç´¢æ¡†ã€æ–‡æœ¬è¾“å…¥æ¡†

3. **æ§åˆ¶å°é¢‘ç¹å‡ºç°"æ£€æµ‹åˆ°è¿‡æœŸçš„å¼‚æ­¥ç»“æœ"**
   - è¿™è¡¨æ˜å¼‚æ­¥åºåˆ—å·é€’å¢è¿‡å¿«
   - å¤§é‡å¼‚æ­¥ç»“æœè¢«ä¸¢å¼ƒ

**ä¸´æ—¶è§£å†³æ–¹æ¡ˆ**ï¼š

åœ¨å®æ–½é˜²æŠ–ä¹‹å‰ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ç¼“è§£é—®é¢˜ï¼š

```typescript
// 1. å‡å°‘å¼‚æ­¥å‡½æ•°çš„æ‰§è¡Œæ—¶é—´
const linkageFunctions = {
  calculateTotal: async (formData: any) => {
    // ä¼˜åŒ–ï¼šä½¿ç”¨ç¼“å­˜ã€å‡å°‘ API è°ƒç”¨
    const cached = cache.get(formData.price);
    if (cached) return cached;

    const result = await expensiveCalculation(formData);
    cache.set(formData.price, result);
    return result;
  },
};

// 2. ä½¿ç”¨ debounce åŒ…è£…è”åŠ¨å‡½æ•°
import { debounce } from 'lodash';

const linkageFunctions = {
  calculateTotal: debounce(async (formData: any) => {
    // å¼‚æ­¥è®¡ç®—
  }, 300),
};
```

---

## 11. å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•è°ƒè¯•è”åŠ¨ä¸ç”Ÿæ•ˆçš„é—®é¢˜ï¼Ÿ

è¯·å‚è€ƒ [åŠ¨æ€è¡¨å•å¸¸è§é—®é¢˜](./DYNAMIC_FORM_PART6.md) ç¬¬ 9.1 èŠ‚ Q5ã€‚

### Q2: å¦‚ä½•å¤„ç†å¾ªç¯ä¾èµ–ï¼Ÿ

ç³»ç»Ÿä¼šåœ¨æ„å»ºä¾èµ–å›¾æ—¶è‡ªåŠ¨æ£€æµ‹å¾ªç¯ä¾èµ–å¹¶åœ¨æ§åˆ¶å°è¾“å‡ºè­¦å‘Šã€‚

### Q3: è”åŠ¨å‡½æ•°å¯ä»¥æ˜¯å¼‚æ­¥çš„å—ï¼Ÿ

å¯ä»¥ã€‚ç³»ç»Ÿå®Œæ•´æ”¯æŒå¼‚æ­¥è”åŠ¨å‡½æ•°ï¼Œè¯¦è§ç¬¬ 6.8 èŠ‚ã€‚

### Q4: Schema è”åŠ¨ä¼šè¦†ç›–åŸæœ‰çš„ ui.linkage é…ç½®å—ï¼Ÿ

ä¸ä¼šã€‚Schema è”åŠ¨åªä¼šæ›´æ–°ä»¥ä¸‹å­—æ®µï¼š
- `properties`ï¼šå­—æ®µå®šä¹‰
- `required`ï¼šå¿…å¡«å­—æ®µ
- æ ¡éªŒç›¸å…³å­—æ®µï¼š`minProperties`ã€`maxProperties`ã€`dependencies`ã€`if/then/else`ã€`allOf/anyOf/oneOf/not`

åŸæœ‰çš„ `ui` é…ç½®ï¼ˆåŒ…æ‹¬ `ui.linkage`ï¼‰ä¼šè¢«å®Œæ•´ä¿ç•™ã€‚è¯¦è§ç¬¬ 3.5 èŠ‚ã€‚

### Q5: å¦‚ä½•å¤„ç†å¼‚æ­¥è”åŠ¨å‡½æ•°çš„ç«æ€æ¡ä»¶ï¼Ÿ

ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†å¼‚æ­¥è¯·æ±‚çš„ç«æ€æ¡ä»¶ã€‚å½“ç”¨æˆ·å¿«é€Ÿåˆ‡æ¢ä¾èµ–å­—æ®µæ—¶ï¼Œåªæœ‰æœ€åä¸€æ¬¡è¯·æ±‚çš„ç»“æœä¼šè¢«åº”ç”¨ï¼Œä¹‹å‰çš„è¿‡æœŸç»“æœä¼šè¢«è‡ªåŠ¨ä¸¢å¼ƒã€‚è¯¦è§ç¬¬ 6.9 èŠ‚ã€‚

### Q6: ä¸²è¡Œä¾èµ–çš„å¼‚æ­¥è”åŠ¨æ˜¯å¦èƒ½æ­£å¸¸å·¥ä½œï¼Ÿ

âš ï¸ **å½“å‰å®ç°å­˜åœ¨ä¸¥é‡é—®é¢˜**ã€‚åœ¨ä¸²è¡Œä¾èµ–åœºæ™¯ä¸­ï¼ˆä¾‹å¦‚ B ä¾èµ– Aï¼ŒC ä¾èµ– A å’Œ Bï¼‰ï¼Œå¦‚æœ B å’Œ C éƒ½æ˜¯å¼‚æ­¥è”åŠ¨ï¼Œå½“å‰å®ç°æ— æ³•ä¿è¯ C ä½¿ç”¨æœ€æ–°çš„ B å€¼ã€‚è¯¦è§ç¬¬ 10.1 èŠ‚çš„å®Œæ•´åˆ†æã€‚

**ç®€è¦è¯´æ˜**ï¼š
- âŒ å½“å‰å®ç°ï¼šC å¯èƒ½ä½¿ç”¨æ—§çš„ B å€¼ï¼Œæ‰€æœ‰å¼‚æ­¥ç»“æœå¯èƒ½è¢«ä¸¢å¼ƒ
- âœ… æ¨èæ–¹æ¡ˆï¼šå®æ–½ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†ï¼ˆç¬¬ 10.1.4 èŠ‚ï¼‰
- âš ï¸ ä¸´æ—¶å»ºè®®ï¼šé¿å…ä½¿ç”¨ä¸²è¡Œä¾èµ–çš„å¼‚æ­¥è”åŠ¨ï¼Œæˆ–ç¡®ä¿è”åŠ¨å‡½æ•°æ˜¯åŒæ­¥çš„

### Q7: å€¼è”åŠ¨åœ¨å®é™…ä½¿ç”¨ä¸­ä¼šæœ‰é—®é¢˜å—ï¼Ÿ

å€¼è”åŠ¨ï¼ˆ`type: 'value'`ï¼‰åœ¨æŸäº›åœºæ™¯ä¸‹å¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯å½“å¼‚æ­¥è”åŠ¨å‡½æ•°æ‰§è¡Œæ—¶é—´è¾ƒé•¿ä¸”ç”¨æˆ·å¿«é€Ÿè¿ç»­è¾“å…¥æ—¶ã€‚è¯¦è§ç¬¬ 10.2 èŠ‚çš„å®Œæ•´åˆ†æå’Œè§£å†³æ–¹æ¡ˆã€‚

**ç®€è¦è¯´æ˜**ï¼š
- âœ… åŒæ­¥è”åŠ¨å‡½æ•°ï¼šå·²é€šè¿‡æ ‡å¿—ä½å®Œå…¨ä¿®å¤ï¼Œæ— é£é™©
- âš ï¸ å¿«é€Ÿå¼‚æ­¥è”åŠ¨ï¼ˆ< 100msï¼‰ï¼šå¤§éƒ¨åˆ†æƒ…å†µæ­£å¸¸
- âš ï¸ æ…¢é€Ÿå¼‚æ­¥è”åŠ¨ï¼ˆ> 500msï¼‰+ å¿«é€Ÿè¾“å…¥ï¼šå¯èƒ½éœ€è¦æ·»åŠ é˜²æŠ–æœºåˆ¶

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒç¬¬ 10.2.7 èŠ‚çš„ä¸´æ—¶è§£å†³æ–¹æ¡ˆã€‚

---

## ç›¸å…³æ–‡æ¡£

- [æ•°ç»„å­—æ®µè”åŠ¨è®¾è®¡æ–¹æ¡ˆ](./ARRAY_FIELD_LINKAGE.md)
- [å­—æ®µè·¯å¾„é€æ˜åŒ–è®¾è®¡æ–¹æ¡ˆ](./FIELD_PATH_FLATTENING.md)
- [å­—æ®µè·¯å¾„å®Œå…¨æŒ‡å—](./FIELD_PATH_GUIDE.md)
- [åŠ¨æ€è¡¨å•å¸¸è§é—®é¢˜](./DYNAMIC_FORM_PART6.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.3
**åˆ›å»ºæ—¥æœŸ**: 2025-12-26
**æœ€åæ›´æ–°**: 2026-01-10
**æ–‡æ¡£çŠ¶æ€**: å·²æ›´æ–°

## å˜æ›´å†å²

### v2.3 (2026-01-10)

**æ–°å¢å†…å®¹**ï¼šä¸²è¡Œä¾èµ–å¼‚æ­¥è”åŠ¨é—®é¢˜åˆ†æä¸è§£å†³æ–¹æ¡ˆ

**ä¸»è¦å˜æ›´**ï¼š

1. **æ–°å¢ç¬¬ 10.1 èŠ‚ï¼šä¸²è¡Œä¾èµ–ä¸­çš„å¼‚æ­¥è”åŠ¨é—®é¢˜**
   - âœ… è¯¦ç»†åˆ†æä¸²è¡Œä¾èµ–åœºæ™¯çš„ä¸‰ä¸ªä¸¥é‡é—®é¢˜
   - âœ… é—®é¢˜ 1ï¼šå¹¶è¡Œæ‰§è¡Œè€Œéä¸²è¡Œ
   - âœ… é—®é¢˜ 2ï¼šformData å¿«ç…§é™ˆæ—§
   - âœ… é—®é¢˜ 3ï¼šæ‰€æœ‰å¼‚æ­¥ç»“æœéƒ½è¿‡æœŸ
   - âœ… æä¾›æµ‹è¯•éªŒè¯å’Œæ‰§è¡Œæ—¥å¿—åˆ†æ

2. **ä¸‰ç§è§£å†³æ–¹æ¡ˆå¯¹æ¯”**
   - âœ… æ–¹æ¡ˆ 1ï¼šé€’å½’è§¦å‘ä¾èµ–å­—æ®µ
   - âœ… æ–¹æ¡ˆ 2ï¼šä»»åŠ¡é˜Ÿåˆ—ç®¡ç†ï¼ˆæ¨èï¼‰
   - âœ… æ–¹æ¡ˆ 3ï¼šå…¨å±€æ ‡å¿—ä½
   - âœ… è¯¦ç»†å¯¹æ¯”è¡¨æ ¼å’Œé€‚ç”¨åœºæ™¯

3. **æ¨èæ–¹æ¡ˆï¼šä»»åŠ¡é˜Ÿåˆ—ç®¡ç†**
   - âœ… ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†å™¨å®ç°
   - âœ… é˜Ÿåˆ—å¤„ç†å™¨å®ç°
   - âœ… watch é›†æˆä»£ç 
   - âœ… å®Œæ•´çš„æ‰§è¡Œæµç¨‹ç¤ºä¾‹

4. **å®æ–½å»ºè®®**
   - âš ï¸ çŸ­æœŸï¼šå½“å‰å®ç°å­˜åœ¨ä¸¥é‡é—®é¢˜
   - ğŸ”§ ä¸­æœŸï¼šå®æ–½ä»»åŠ¡é˜Ÿåˆ—æ–¹æ¡ˆ
   - ğŸ”§ é•¿æœŸï¼šæ·»åŠ é˜²æŠ–å’Œ loading çŠ¶æ€

5. **æ›´æ–°å¸¸è§é—®é¢˜**
   - âœ… æ–°å¢ Q6ï¼šä¸²è¡Œä¾èµ–çš„å¼‚æ­¥è”åŠ¨æ˜¯å¦èƒ½æ­£å¸¸å·¥ä½œï¼Ÿ
   - âœ… æä¾›é—®é¢˜è¯´æ˜å’Œä¸´æ—¶å»ºè®®

**æ–‡æ¡£è§„æ¨¡**ï¼š~2300 è¡Œï¼ˆæ–°å¢çº¦ 300 è¡Œï¼‰

### v2.2 (2026-01-10)

**æ–°å¢å†…å®¹**ï¼šå€¼è”åŠ¨æ½œåœ¨é—®é¢˜åˆ†æä¸è§£å†³æ–¹æ¡ˆ

**ä¸»è¦å˜æ›´**ï¼š

1. **æ–°å¢ç¬¬ 10 ç« ï¼šå·²çŸ¥é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ**
   - âœ… è¯¦ç»†åˆ†æå€¼è”åŠ¨è§¦å‘ watch çš„ä¸¤ä¸ªé—®é¢˜
   - âœ… é—®é¢˜ Aï¼šsetValue è§¦å‘ watch çš„æ­»å¾ªç¯é£é™©
   - âœ… é—®é¢˜ Bï¼šæµ‹è¯•ç¯å¢ƒä¸­çš„ watch å¤šæ¬¡è§¦å‘
   - âœ… æä¾›å®Œæ•´çš„é—®é¢˜åœºæ™¯ç¤ºä¾‹å’Œä»£ç æ¼”ç¤º

2. **å½“å‰ç¼“è§£æªæ–½è¯´æ˜**
   - âœ… æ ‡å¿—ä½æœºåˆ¶é˜²æ­¢æ­»å¾ªç¯ï¼ˆå·²å®ç°ï¼‰
   - âœ… æµ‹è¯•ä¸­å¢åŠ ç­‰å¾…æ—¶é—´ï¼ˆå·²å®ç°ï¼‰
   - âœ… è¯´æ˜å½“å‰å®ç°çš„çŠ¶æ€å’Œæ•ˆæœ

3. **å®é™…ä½¿ç”¨åœºæ™¯é£é™©è¯„ä¼°**
   - âœ… åˆ†æç”¨æˆ·å¿«é€Ÿè¿ç»­è¾“å…¥çš„é£é™©
   - âœ… åˆ†æå¤šä¸ªå­—æ®µåŒæ—¶å˜åŒ–çš„é£é™©
   - âœ… æä¾›é£é™©ç­‰çº§è¯„ä¼°è¡¨

4. **ä¸‰ç§è§£å†³æ–¹æ¡ˆå¯¹æ¯”**
   - âœ… æ–¹æ¡ˆ 1ï¼šæ·»åŠ é˜²æŠ–æœºåˆ¶ï¼ˆæ¨èï¼‰
   - âœ… æ–¹æ¡ˆ 2ï¼šæ”¹è¿›å¼‚æ­¥åºåˆ—ç®¡ç†å™¨
   - âœ… æ–¹æ¡ˆ 3ï¼šæ··åˆæ–¹æ¡ˆï¼ˆæœ€ä½³å®è·µï¼‰
   - âœ… æ¯ä¸ªæ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹å’Œé€‚ç”¨åœºæ™¯

5. **å®æ–½å»ºè®®å’Œå¼€å‘è€…æ³¨æ„äº‹é¡¹**
   - âœ… çŸ­æœŸã€ä¸­æœŸã€é•¿æœŸçš„å®æ–½è·¯çº¿å›¾
   - âœ… å¼€å‘è€…ä½¿ç”¨å€¼è”åŠ¨æ—¶çš„æ³¨æ„äº‹é¡¹
   - âœ… ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼ˆç¼“å­˜ã€debounce åŒ…è£…ï¼‰

6. **æ›´æ–°å¸¸è§é—®é¢˜**
   - âœ… æ–°å¢ Q6ï¼šå€¼è”åŠ¨åœ¨å®é™…ä½¿ç”¨ä¸­ä¼šæœ‰é—®é¢˜å—ï¼Ÿ
   - âœ… æä¾›ç®€è¦è¯´æ˜å’Œé£é™©è¯„ä¼°

**æ–‡æ¡£è§„æ¨¡**ï¼š~2000 è¡Œï¼ˆæ–°å¢çº¦ 340 è¡Œï¼‰

### v2.1 (2026-01-09)

**æ–°å¢åŠŸèƒ½**ï¼šSchema è”åŠ¨å’Œå¼‚æ­¥ç«æ€æ¡ä»¶å¤„ç†

**ä¸»è¦å˜æ›´**ï¼š

1. **æ–°å¢ Schema è”åŠ¨ç±»å‹**
   - âœ… æ‰©å±• `LinkageType` æ”¯æŒ `'schema'` ç±»å‹
   - âœ… æ”¯æŒåŸºäºè¡¨å•æ•°æ®å¼‚æ­¥åŠ è½½ schema ç»“æ„
   - âœ… Schema æ›´æ–°åªå½±å“ properties å’Œæ ¡éªŒå­—æ®µï¼Œä¿ç•™åŸæœ‰ ui é…ç½®
   - âœ… æ–°å¢ç¬¬ 3.5 èŠ‚ï¼šåŠ¨æ€ Schemaï¼ˆå¼‚æ­¥åŠ è½½ï¼‰ç¤ºä¾‹

2. **å¼‚æ­¥ç«æ€æ¡ä»¶å¤„ç†**
   - âœ… å®ç° AsyncSequenceManager åºåˆ—å·ç®¡ç†å™¨
   - âœ… è‡ªåŠ¨å¤„ç†å¼‚æ­¥è¯·æ±‚çš„ç«æ€æ¡ä»¶
   - âœ… ç¡®ä¿åªæœ‰æœ€æ–°çš„å¼‚æ­¥ç»“æœä¼šè¢«åº”ç”¨
   - âœ… æ–°å¢ç¬¬ 6.9 èŠ‚ï¼šå¼‚æ­¥ç«æ€æ¡ä»¶å¤„ç†è¯¦ç»†è¯´æ˜

3. **æ–‡æ¡£æ›´æ–°**
   - âœ… æ›´æ–°ç±»å‹å®šä¹‰ï¼Œæ·»åŠ  `schema` å­—æ®µåˆ° `LinkageResult`
   - âœ… æ›´æ–°è®¾è®¡è¯´æ˜ï¼Œè¡¥å……å¼‚æ­¥æ”¯æŒå’Œç«æ€æ¡ä»¶å¤„ç†
   - âœ… æ–°å¢ Q4 å’Œ Q5 å¸¸è§é—®é¢˜
   - âœ… æ›´æ–°æ ¸å¿ƒä¼˜åŠ¿åˆ—è¡¨

**å®ç°æ–‡ä»¶**ï¼š
- `src/components/DynamicForm/types/linkage.ts`
- `src/components/DynamicForm/hooks/useLinkageManager.ts`
- `src/components/DynamicForm/widgets/NestedFormWidget.tsx`
- `src/pages/examples/NestedForm/SchemaLoaderExample.tsx`

### v2.0 (2025-12-30)

**é‡å¤§é‡æ„**ï¼šç²¾ç®€æ–‡æ¡£ï¼Œä¼˜åŒ–ç« èŠ‚ç»“æ„ï¼Œè¡¥å……å…³é”®å®ç°ç»†èŠ‚

**ä¸»è¦å˜æ›´**ï¼š

1. **ä¿®æ­£ç±»å‹å®šä¹‰**
   - âœ… ä½¿ç”¨è”åˆç±»å‹ `ConditionExpression = SingleCondition | LogicalCondition`
   - âœ… ç¡®ä¿ç±»å‹å®‰å…¨ï¼Œå•æ¡ä»¶å’Œé€»è¾‘ç»„åˆä¸èƒ½æ··ç”¨

2. **ä¼˜åŒ–ç« èŠ‚ç»“æ„**
   - âœ… å°† PathMappingã€åˆ†å±‚è®¡ç®—ã€DynamicForm é›†æˆåˆå¹¶åˆ°ç¬¬ 6 èŠ‚ï¼ˆå®ç°æ–¹æ¡ˆï¼‰
   - âœ… è°ƒæ•´ç« èŠ‚é¡ºåºï¼šç«¯åˆ°ç«¯ç¤ºä¾‹å‰ç½®åˆ°ç¬¬ 7 èŠ‚
   - âœ… åˆ é™¤"é«˜çº§ç‰¹æ€§"æ ‡é¢˜ï¼Œé¿å…è¯¯å¯¼

3. **è¡¥å……å…³é”®å®ç°ç»†èŠ‚**
   - âœ… 6.4 èŠ‚ï¼šPathMapping æœºåˆ¶è¯¦ç»†è¯´æ˜
   - âœ… 6.5 èŠ‚ï¼šåˆ†å±‚è®¡ç®—ç­–ç•¥å’Œå·¥ä½œæµç¨‹
   - âœ… 6.6 èŠ‚ï¼šDynamicForm é›†æˆï¼ˆäº”æ­¥æµç¨‹ï¼‰
   - âœ… 6.7 èŠ‚ï¼šä¾èµ–å›¾ä¼˜åŒ–
   - âœ… 6.8 èŠ‚ï¼šå¼‚æ­¥å‡½æ•°æ”¯æŒ
   - âœ… ç¬¬ 7 èŠ‚ï¼šå®Œæ•´çš„ç«¯åˆ°ç«¯ç¤ºä¾‹

4. **ç²¾ç®€é‡å¤å†…å®¹**
   - âœ… åˆ é™¤ä¸ä¸“é¢˜æ–‡æ¡£é‡å¤çš„è¯¦ç»†è¯´æ˜
   - âœ… æ”¹ä¸ºå¼•ç”¨ç›¸å…³æ–‡æ¡£é“¾æ¥

**æ–‡æ¡£è§„æ¨¡**ï¼š~900 è¡Œï¼ˆç²¾ç®€ 55%ï¼Œä½†å†…å®¹æ›´å……å®ï¼‰

### v1.0 (2025-12-26)

åˆå§‹ç‰ˆæœ¬ï¼ŒåŒ…å«å®Œæ•´çš„ UI è”åŠ¨è®¾è®¡æ–¹æ¡ˆã€‚
